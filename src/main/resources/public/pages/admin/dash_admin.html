<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Amministratore - Sistema Distributori</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
    .status-available {
	    background-color: green;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}
	
	.status-maintenance {
	    background-color: yellow;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}
	
	.status-inactive {
	    background-color: #fd0006;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}
	
	.status-unknown {
	    background-color: gray;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}
	.status-badge {
	    display: inline-block;
	    width: 12px;
	    height: 12px;
	    border-radius: 50%;
	    margin-right: 8px;
	}
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4" style="background-color:grey">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold" >Dashboard Amministratore</h1> 
            <div>
                <span id="userInfo" class="mr-3"></span>
                <button onclick="window.location.href = '/index.html'" class="bg-blue-500 px-3 py-2 rounded hover:bg-blue-600">
                    Home
                </button>
               </div>
               <div>
                <button onclick="window.location.href = '/spegni'" class="bg-red-500 px-3 py-2 rounded hover:bg-red-600">
                    <i class="fa-solid fa-power-off"></i>
                </button>
                
            </div>
               <div>
                <span id="userInfo" class="user-info">
                <span id="userName"></span>
                 <i class="fas fa-user"></i>
                </span>
                <button onclick="logout()" class="bg-red-500 px-3 py-2 rounded hover:bg-red-600">
                    Logout
                </button>
            </div>
        </div>
    </nav>
    
    

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Navigation Tabs -->
        <div class="mb-4 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px" id="myTab">
                <li class="mr-2">
                    <button onclick="showTab('istituti')" class="tab-btn inline-block p-4" data-tab="istituti">
                        <i class="fas fa-building mr-2"></i>Istituti
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('macchine')" class="tab-btn inline-block p-4" data-tab="macchine">
                        <i class="fas fa-coffee mr-2"></i>Macchine
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('magazzino')" class="tab-btn inline-block p-4" data-tab="magazzino">
                        <i class="fas fa-warehouse mr-2"></i>Magazzino
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('finanze')" class="tab-btn inline-block p-4" data-tab="finanze">
                        <i class="fas fa-chart-line mr-2"></i>Finanze
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('utenti')" class="tab-btn inline-block p-4" data-tab="utenti">
                        <i class="fas fa-users mr-2"></i>Utenti
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('monitoraggio')" class="tab-btn inline-block p-4" data-tab="monitoraggio">
                        <i class="fas fa-desktop mr-2"></i>Monitoraggio
                    </button>
                </li>
            </ul>
        </div>

        <!-- Tab Contents -->
        <div id="tabContents">
            <!-- Istituti Tab -->
            <div id="istituti" class="tab-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">Gestione Istituti</h2>
                    <button onclick="showModal('addIstitutoModal')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Nuovo Istituto
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2">Nome</th>
                                <th class="text-left py-2">Indirizzo</th>
                                <th class="text-left py-2">Macchine</th>
                                <th class="text-left py-2">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="istitutiList">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Macchine Tab -->
            <div id="macchine" class="tab-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">Gestione Macchine</h2>
                    <button onclick="showModal('addMacchinaModal')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Nuova Macchina
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2">ID</th>
                                <th class="text-left py-2">Istituto</th>
                                <th class="text-left py-2">Stato</th>
                                <th class="text-left py-2">Incasso</th>
                                <th class="text-left py-2">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="macchineList">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Magazzino Tab -->
			<div id="magazzino" class="tab-content hidden">
			    <!-- Tab Navigation -->
			    <div class="mb-4 border-b border-gray-200">
			        <ul class="flex flex-wrap -mb-px" id="magazzinoTabs">
			            <li class="mr-2">
			                <button onclick="showMagazzinoTab('bevande')" class="magazzino-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-blue-600 hover:border-blue-600" data-tab="bevande">
			                    <i class="fas fa-coffee mr-2"></i>Bevande Disponibili
			                </button>
			            </li>
			            <li class="mr-2">
			                <button onclick="showMagazzinoTab('cialde')" class="magazzino-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-blue-600 hover:border-blue-600" data-tab="cialde">
			                    <i class="fas fa-archive mr-2"></i>Cialde Disponibili
			                </button>
			            </li>
			        </ul>
			    </div>
			    
			    <!-- Tab Contents -->
			    <div class="bg-white rounded-lg shadow p-4">
			        <!-- Bevande Tab Content -->
			        <div id="bevandeTab" class="magazzino-tab-content">
			            <h3 class="text-lg font-bold mb-4">Bevande Disponibili</h3>
			            <div id="bevandeList" class="space-y-4">
			                <!-- Populated by JavaScript -->
			                <div class="text-center text-gray-500">
			                    <i class="fas fa-spinner fa-spin mr-2"></i>Caricamento...
			                </div>
			            </div>
			        </div>
			        
			        <!-- Cialde Tab Content -->
			        <div id="cialdeTab" class="magazzino-tab-content hidden">
			            <h3 class="text-lg font-bold mb-4">Cialde Disponibili</h3>
			            <div id="cialdeList" class="space-y-4">
			                <!-- Populated by JavaScript -->
			                <div class="text-center text-gray-500">
			                    <i class="fas fa-spinner fa-spin mr-2"></i>Caricamento...
			                </div>
			            </div>
			        </div>
			    </div>
			</div>

            <!-- Finanze Tab -->
            <div id="finanze" class="tab-content hidden">
		    <!-- Sotto-tab per le transazioni -->
		    <div class="mb-4 border-b border-gray-200">
		        <ul class="flex flex-wrap -mb-px" id="finanzeTabs">
		            <li class="mr-2">
		                <button onclick="showFinanzeTab('tutte')" class="finanze-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-blue-600 hover:border-blue-600" data-tab="tutte">
		                    Tutte le transazioni
		                </button>
		            </li>
		            
		            <li class="mr-2">
		                <button onclick="showFinanzeTab('macchina')" class="finanze-tab-btn inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-blue-600 hover:border-blue-600" data-tab="macchina">
		                    Transazioni per macchina
		                </button>
		            </li>
		        </ul>
		    </div>
		    
		    <div class="bg-white rounded-lg shadow p-4">
		        <!-- Tutte le transazioni -->
		        <div id="tutteTab" class="finanze-tab-content">
		            <h3 class="text-lg font-bold mb-4">Tutte le transazioni</h3>
		            <div id="tutteTransazioniList" class="space-y-4">
		                <div class="text-center text-gray-500">
		                    <i class="fas fa-spinner fa-spin mr-2"></i>Caricamento...
		                </div>
		            </div>
		        </div>
		
		        <!-- Transazioni per macchina -->
		        <div id="macchinaTab" class="finanze-tab-content hidden">
		            <h3 class="text-lg font-bold mb-4">Transazioni per macchina</h3>
		            <div class="mb-4">
		                <select id="macchinaSelect" class="px-3 py-2 border rounded w-full">
		                    <option value="">Seleziona una macchina</option>
		                    <!-- Le opzioni verranno popolate dinamicamente -->
		                </select>
		            </div>
		            <div id="macchinaTransazioniList" class="space-y-4">
		                <div class="text-center text-gray-500">
		                    <i class="fas fa-spinner fa-spin mr-2"></i>Seleziona una macchina per vedere le transazioni.
		                </div>
		            </div>
		        </div>
		    </div>
		</div>
            <!-- Utenti Tab -->
            <div id="utenti" class="tab-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">Gestione Utenti</h2>
                    <button onclick="showModal('addUserModal')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Nuovo Utente
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2">Nome</th>
                                <th class="text-left py-2">Ruolo</th>
                                <th class="text-left py-2">Ultimo Accesso</th>
                                <th class="text-left py-2">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="utentiList">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Monitoraggio Tab -->
            <div id="monitoraggio" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Stato Sistema</h3>
                        <div id="statoSistema"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Allarmi Attivi</h3>
                        <div id="allarmiList"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Performance</h3>
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Istituto Modal -->
    <div id="addIstitutoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Aggiungi Nuovo Istituto</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" id="nomeIstituto" placeholder="Nome Istituto" class="mb-3 px-3 py-2 border rounded w-full">
                    <input type="text" id="indirizzoIstituto" placeholder="Indirizzo" class="mb-3 px-3 py-2 border rounded w-full">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveIstitutoBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Salva
                    </button>
                    <button onclick="hideModal('addIstitutoModal')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Macchina Modal -->
    <div id="addMacchinaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Aggiungi Nuova Macchina</h3>
                <div class="mt-2 px-7 py-3">
                    <select id="istitutoSelect" class="mb-3 px-3 py-2 border rounded w-full">
                        <!-- Populated by JavaScript -->
                    </select>
                    <input type="number" id="cassaMassima" placeholder="Capacità Cassa" class="mb-3 px-3 py-2 border rounded w-full">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveMacchinaBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Salva
                    </button>
                    <button onclick="hideModal('addMacchinaModal')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Aggiungi Nuovo Utente</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" id="nomeUtente" placeholder="Nome" class="mb-3 px-3 py-2 border rounded w-full">
                    <input type="text" id="username" placeholder="Username" class="mb-3 px-3 py-2 border rounded w-full">
                    <input type="password" id="password" placeholder="Password" class="mb-3 px-3 py-2 border rounded w-full">
                    <select id="ruoloSelect" class="mb-3 px-3 py-2 border rounded w-full">
                        <option value="Amministratore">Amministratore</option>
                        <option value="Tecnico">Tecnico</option>
                        <option value="Operatore">Operatore</option>
                    </select>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveUserBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Salva
                    </button>
                    <button onclick="hideModal('addUserModal')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const userInfo = document.getElementById('userInfo');
    const userNameSpan = document.getElementById('userName');
    userNameSpan.textContent = localStorage.getItem('user_name');
        // API Configuration
        const API_BASE_URL = 'https://localhost:8443/api';
        let currentUser = null;
        let currentTab = 'istituti';

        // Check Authentication
        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                window.location.href = '/index.html';
                return;
            }
            
            // Set authorization header for all requests
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            
        }

        // Logout Function
        function logout() {
            localStorage.removeItem('jwt_token');
            window.location.href = '/index.html';
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600', 'border-b-2');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('text-blue-600', 'border-blue-600', 'border-b-2');
            
            currentTab = tabName;
            loadTabData(tabName);
        }

        // Modal Management
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Load Tab Data
        function loadTabData(tabName) {
            switch(tabName) {
                case 'istituti':
                    loadIstituti();
                    break;
                case 'macchine':
                    loadMacchine();
                    break;
                case 'magazzino':
                    loadMagazzino();
                    break;
                case 'finanze':
                    loadFinanze();
                    break;
                case 'utenti':
                    loadUtenti();
                    break;
                case 'monitoraggio':
                    loadMonitoraggio();
                    break;
            }
        }

        // Funzione per caricare gli istituti con la funzionalità espandibile
      function loadIstituti() {
    axios.get(`${API_BASE_URL}/istituti`)
        .then(response => {
            const istituti = response.data;
            const tbody = document.getElementById('istitutiList');
            tbody.innerHTML = '';
            
            istituti.forEach(istituto => {
                const macchine = istituto.macchine ? istituto.macchine.length : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">${istituto.nome}</td>
                    <td class="py-2">${istituto.indirizzo}</td>
                    <td class="py-2">
                        <button onclick="toggleMacchineIstituto(${istituto.ID_istituto})" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="fa-solid fa-eye"></i> ${macchine}
                        </span>
                    </td>
                    <td class="py-2">
                        <button onclick="editIstituto(${istituto.ID_istituto})" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteIstituto(${istituto.ID_istituto})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Creiamo una riga nascosta per il contenuto espandibile
                const contentRow = document.createElement('tr');
                contentRow.id = `istituto-macchine-${istituto.ID_istituto}`;
                contentRow.className = 'hidden';
                contentRow.innerHTML = `
                    <td colspan="4" class="py-2 px-4 bg-gray-50">

                        <div id="macchine-list-${istituto.ID_istituto}" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="text-center text-gray-500">Caricamento...</div>
                        </div>
                    </td>
                `;
                tbody.appendChild(contentRow);
            });
        })
        .catch(error => {
            console.error('Error loading istituti:', error);
            alert('Errore nel caricamento degli istituti');
        });
}

function toggleMacchineIstituto(istitutoId) {
    const contentRow = document.getElementById(`istituto-macchine-${istitutoId}`);
    const macchineList = document.getElementById(`macchine-list-${istitutoId}`);

    if (contentRow.classList.contains('hidden')) {
        // Se la riga è nascosta, la mostriamo e carichiamo le macchine
        contentRow.classList.remove('hidden');
        loadMacchineIstituto(istitutoId, macchineList);
    } else {
        // Se la riga è visibile, la nascondiamo
        contentRow.classList.add('hidden');
    }
}

function loadMacchineIstituto(istitutoId, macchineList) {
    axios.get(`${API_BASE_URL}/istituti/${istitutoId}/macchine`)
        .then(response => {
            const macchine = response.data;
            macchineList.innerHTML = ''; // Svuotiamo il contenuto di caricamento

            if (macchine.length === 0) {
                macchineList.innerHTML = '<div class="text-center text-gray-500">Nessuna macchina disponibile</div>';
            } else {
                macchine.forEach(machine => {
                    const macchinaDiv = document.createElement('div');
                    macchinaDiv.className = 'bg-white p-4 rounded-lg shadow';
                    macchinaDiv.innerHTML = `
                        <div class="machine-card" onclick="showMacchinaDetails(${machine.id})" data-toggle="tooltip" data-placement="top" title="Clicca per vedere le informazioni sulla macchina">
                        <div class="machine-header">
                        <div class="status-badge ${getStatusClass(machine.statoId)}"></div>
                            <div><h4><b>ID Macchina: #${machine.id}</b> </h4></div>
                        </div>
                        <div class="machine-info">
                            <p>Stato: ${machine.statoDescrizione}</p>
                            <p>Cassa: €${machine.cassaAttuale.toFixed(2)} / €${machine.cassaMassima.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                    macchineList.appendChild(macchinaDiv);
                });
            }
        })
        .catch(error => {
            console.error('Error loading macchine:', error);
            macchineList.innerHTML = '<div class="text-center text-red-500">Errore nel caricamento delle macchine</div>';
        });
}

function getStatusClass (statoId) {
    const classi = {
            1: 'status-available',
            2: 'status-maintenance',
            3: 'status-inactive'
        };
        return classi[statoId] || 'status-unknown';
    }

        // Save Istituto
        document.getElementById('saveIstitutoBtn').addEventListener('click', () => {
            const nome = document.getElementById('nomeIstituto').value;
            const indirizzo = document.getElementById('indirizzoIstituto').value;
            if (!nome || !indirizzo) {
                alert('Compilare tutti i campi');
                return;
            }
            
            axios.post(`${API_BASE_URL}/admin/istituti`, { nome, indirizzo })
                .then(() => {
                    hideModal('addIstitutoModal');
                    loadIstituti();
                })
                .catch(error => {
                    console.error('Error saving istituto:', error);
                    alert('Errore nel salvataggio dell\'istituto');
                });
        });

        // Machine Management
        function loadMacchine() {
            axios.get(`${API_BASE_URL}/macchine`)
                .then(response => {
                    const macchine = response.data;
                    const tbody = document.getElementById('macchineList');
                    tbody.innerHTML = '';
                    
                    macchine.forEach(macchina => {
                        const row = document.createElement('tr');
                        row.className = 'cursor-pointer hover:bg-gray-50';
                        row.onclick = () => showMacchinaDetails(macchina.id);
                        row.innerHTML = `
                            <td class="py-2">${macchina.id}</td>
                            <td class="py-2">${macchina.nomeIstituto}</td>
                            <td class="py-2">
                                <span class="px-2 py-1 rounded ${getStatoClass(macchina.statoId)}">
                                    ${macchina.statoDescrizione}
                                </span>
                            </td>
                            <td class="py-2">€${macchina.cassaAttuale.toFixed(2)}</td>
                            <td class="py-2" onclick="event.stopPropagation()">
                                <button onclick="configuraMacchina(${macchina.id})" class="text-blue-500 hover:text-blue-700 mr-2">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <button onclick="deleteMacchina(${macchina.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading macchine:', error);
                    alert('Errore nel caricamento delle macchine');
                });
        }

        // Funzione per mostrare i dettagli di una macchina in un modal
        function showMacchinaDetails(macchinaId) {
            // Assicuriamoci che esista un modal per i dettagli della macchina
            if (!document.getElementById('macchinaDetailsModal')) {
                const modal = document.createElement('div');
                modal.id = 'macchinaDetailsModal';
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center';
                modal.innerHTML = `
                    <div class="relative mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center border-b pb-3">
                            <h3 class="text-lg font-medium text-gray-900" id="macchinaDetailsTitle">Dettagli Macchina</h3>
                            <button onclick="hideModal('macchinaDetailsModal')" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="macchinaDetailsContent" class="mt-4">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
                                <p>Caricamento...</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Mostriamo il modal
            showModal('macchinaDetailsModal');
            
            // Carichiamo i dettagli della macchina
            axios.get(`${API_BASE_URL}/macchine/${macchinaId}`)
                .then(response => {
                    const macchina = response.data;
                    const contentDiv = document.getElementById('macchinaDetailsContent');
                    const title = document.getElementById('macchinaDetailsTitle');
                    
                    title.textContent = `Dettagli Macchina #${macchina.id}`;
                    
                    // Organizziamo i dati in sezioni
                    let bevandeHtml = '';
                    if (macchina.bevande && macchina.bevande.length > 0) {
                        bevandeHtml = `
                            <div class="mt-4">
                                <h4 class="font-medium text-gray-700 mb-2">Bevande Disponibili</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${macchina.bevande.map(bevanda => `
                                        <div class="border rounded p-2 bg-gray-50">
                                            <div class="font-medium">${bevanda.nome}</div>
                                            <div class="text-sm">Prezzo: €${bevanda.prezzo.toFixed(2)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    let cialdeHtml = '';
                    if (macchina.cialde && macchina.cialde.length > 0) {
                        cialdeHtml = `
                            <div class="mt-4">
                                <h4 class="font-medium text-gray-700 mb-2">Stato Cialde</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${macchina.cialde.map(cialda => `
                                        <div class="border rounded p-2 bg-gray-50">
                                            <div class="font-medium">${cialda.nomeCialda || 'Cialda #' + cialda.cialdaId}</div>
                                            <div class="text-sm">Quantità: ${cialda.quantita}/${cialda.quantitaMassima}</div>
                                            <div class="mt-1 bg-gray-200 rounded-full h-2.5">
                                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${(cialda.quantita/cialda.quantitaMassima*100).toFixed(0)}%"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Componiamo il contenuto completo
                    contentDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">Informazioni Generali</h4>
                                <table class="min-w-full text-sm">
                                    <tr>
                                        <td class="py-1 font-medium">ID:</td>
                                        <td>${macchina.id}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Istituto:</td>
                                        <td>${macchina.nomeIstituto}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Stato:</td>
                                        <td>
                                            <span class="px-2 py-1 rounded ${getStatoClass(macchina.statoId)}">
                                                ${macchina.statoDescrizione}
                                            </span>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">Stato Cassa</h4>
                                <table class="min-w-full text-sm">
                                    <tr>
                                        <td class="py-1 font-medium">Credito Attuale:</td>
                                        <td>€${macchina.creditoAttuale.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Cassa Attuale:</td>
                                        <td>€${macchina.cassaAttuale.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Capacità Cassa:</td>
                                        <td>€${macchina.cassaMassima.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Riempimento:</td>
                                        <td>
                                            <div class="mt-1 bg-gray-200 rounded-full h-2.5">
                                                <div class="bg-green-600 h-2.5 rounded-full" 
                                                    style="width: ${(macchina.cassaAttuale/macchina.cassaMassima*100).toFixed(0)}%"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        ${bevandeHtml}
                        ${cialdeHtml}
                        
                        <div class="mt-6 text-right">
                            <button onclick="configuraMacchina(${macchina.id})" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                <i class="fas fa-cog mr-2"></i>Cambia stato
                            </button>
                            <button onclick="hideModal('macchinaDetailsModal')" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Chiudi
                            </button>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading macchina details:', error);
                    const contentDiv = document.getElementById('macchinaDetailsContent');
                    contentDiv.innerHTML = `
                        <div class="text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Errore nel caricamento dei dettagli della macchina.</p>
                        </div>
                    `;
                });
        }
        
        // Add macchina
        function addMacchina() {
    		const istitutoId = document.getElementById('istitutoSelect').value;
    		const cassaMassima = document.getElementById('cassaMassima').value;

		    if (!istitutoId || !cassaMassima) {
		        alert('Compilare tutti i campi');
		        return;
		    }
		
		    axios.post(`${API_BASE_URL}/admin/macchine`, { istitutoId, cassaMassima })
		        .then(() => {
		            hideModal('addMacchinaModal');
		            loadMacchine();
		        })
		        .catch(error => {
		            console.error('Error adding machine:', error);
		            alert('Errore nell\'aggiunta della macchina');
		        });
		}
        
        // Modifica stato macchina
        function updateStatoMacchina(id, statoId) {
		    axios.put(`${API_BASE_URL}/admin/macchine/${id}/stato`, { statoId })
		        .then(() => {
		            loadMacchine();
		        })
		        .catch(error => {
		            console.error('Error updating machine status:', error);
		            alert('Errore nell\'aggiornamento dello stato della macchina');
		        });
		}
        
        // Delete macchina
        function deleteMacchina(id) {
		    if (confirm('Sei sicuro di voler eliminare questa macchina?')) {
		        axios.delete(`${API_BASE_URL}/admin/macchine/${id}`)
		            .then(() => {
		                loadMacchine();
		            })
		            .catch(error => {
		                console.error('Error deleting machine:', error);
		                alert('Errore nell\'eliminazione della macchina');
		            });
		    }
		}
        // Modifica Istituto
        function editIstituto(id) {
		    const nome = prompt('Nuovo nome istituto:');
		    const indirizzo = prompt('Nuovo indirizzo:');
		
		    if (nome && indirizzo) {
		        axios.put(`${API_BASE_URL}/admin/istituti/${id}`, { nome, indirizzo })
		            .then(() => {
		                loadIstituti();
		            })
		            .catch(error => {
		                console.error('Error updating istituto:', error);
		                alert('Errore nell\'aggiornamento dell\'istituto');
		            });
		    }
		}

        function deleteIstituto(id) {
            if (confirm('Sei sicuro di voler eliminare questo istituto?')) {
                axios.delete(`${API_BASE_URL}/admin/istituti/${id}`)
                    .then(() => {
                        loadIstituti();
                    })
                    .catch(error => {
                        console.error('Error deleting istituto:', error);
                        alert('Errore nell\'eliminazione dell\'istituto');
                    });
            }
        }

        // Gestione Macchine
        function configuraMacchina(id) {
            const statoId = prompt('Nuovo stato (1=Attiva, 2=Manutenzione, 3=Fuori servizio):');
            if (statoId) {
                axios.put(`${API_BASE_URL}/admin/macchine/${id}/stato`, { statoId: parseInt(statoId) })
                    .then(() => {
                    	loadMacchine();
                    	alert('Stato aggiornato correttamente!');
                    })
                    .catch(error => {
                        console.error('Error updating machine status:', error);
                        alert('Errore nell\'aggiornamento dello stato della macchina');
                    });
            }
        }

        // Add Bevanda
        function addBevanda() {
		    const nome = prompt('Nome bevanda:');
		    const prezzo = prompt('Prezzo:');
		
		    if (nome && prezzo) {
		        axios.post(`${API_BASE_URL}/admin/bevande`, { nome, prezzo })
		            .then(() => {
		                loadBevande();
		            })
		            .catch(error => {
		                console.error('Error adding beverage:', error);
		                alert('Errore nell\'aggiunta della bevanda');
		            });
		    }
		}
        
        // Aggiorna bevanda
        function updateBevanda(id) {
            const nome = prompt('Nuovo nome bevanda:');
            const prezzo = prompt('Nuovo prezzo:');

            if (nome && prezzo) {
                axios.put(`${API_BASE_URL}/admin/bevande/${id}`, { nome, prezzo })
                    .then(() => {
                        loadBevande();
                    })
                    .catch(error => {
                        console.error('Error updating beverage:', error);
                        alert('Errore nell\'aggiornamento della bevanda');
                    });
            }
        }
        // Elimina bevanda
        function deleteBevanda(id) {
            if (confirm('Sei sicuro di voler eliminare questa bevanda?')) {
                axios.delete(`${API_BASE_URL}/admin/bevande/${id}`)
                    .then(() => {
                        loadBevande();
                    })
                    .catch(error => {
                        console.error('Error deleting beverage:', error);
                        alert('Errore nell\'eliminazione della bevanda');
                    });
            }
        }

        // Gestione Manutenzioni
        function loadManutenzioni() {
            axios.get(`${API_BASE_URL}/manutenzioni`)
                .then(response => {
                    const manutenzioni = response.data;
                    // Implementare la visualizzazione delle manutenzioni
                })
                .catch(error => {
                    console.error('Error loading maintenance data:', error);
                    alert('Errore nel caricamento delle manutenzioni');
                });
        }

        function iniziaManutenzione(macchinaId) {
            axios.post(`${API_BASE_URL}/manutenzione`, { macchinaId })
                .then(() => {
                    loadManutenzioni();
                })
                .catch(error => {
                    console.error('Error starting maintenance:', error);
                    alert('Errore nell\'avvio della manutenzione');
                });
        }

        function completaManutenzione(id) {
            axios.put(`${API_BASE_URL}/manutenzione/${id}/completa`)
                .then(() => {
                    loadManutenzioni();
                })
                .catch(error => {
                    console.error('Error completing maintenance:', error);
                    alert('Errore nel completamento della manutenzione');
                });
        }

        function setFuoriServizio(macchinaId) {
            axios.put(`${API_BASE_URL}/manutenzione/${macchinaId}/fuori-servizio`)
                .then(() => {
                    loadMacchine();
                })
                .catch(error => {
                    console.error('Error setting machine out of service:', error);
                    alert('Errore nell\'impostazione fuori servizio');
                });
        }
        
     // Gestione Tab Magazzino
        function showMagazzinoTab(tabName) {
            // Nascondi tutti i contenuti dei tab
            document.querySelectorAll('.magazzino-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Rimuovi la classe attiva da tutti i tab
            document.querySelectorAll('.magazzino-tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600', 'border-b-2');
                btn.classList.add('border-transparent');
            });
            
            // Mostra il tab selezionato
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.querySelector(`.magazzino-tab-btn[data-tab="${tabName}"]`).classList.add('text-blue-600', 'border-blue-600', 'border-b-2');
            document.querySelector(`.magazzino-tab-btn[data-tab="${tabName}"]`).classList.remove('border-transparent');
            
            // Carica i dati se necessario
            if (tabName === 'bevande') {
                loadBevande();
            } else if (tabName === 'cialde') {
                loadCialde();
            }
        }

        function loadMagazzino() {
            // Mostra il primo tab di default
            showMagazzinoTab('bevande');
        }

        function loadBevande() {
            const bevandeList = document.getElementById('bevandeList');
            bevandeList.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Caricamento...</div>';
            
            axios.get(`${API_BASE_URL}/bevande`)
                .then(response => {
                    const bevande = response.data;
                    bevandeList.innerHTML = '';
                    
                    if (!bevande || bevande.length === 0) {
                        bevandeList.innerHTML = '<div class="text-center text-gray-500">Nessuna bevanda disponibile</div>';
                        return;
                    }
                    
                    bevande.forEach(bevanda => {
                        const card = document.createElement('div');
                        card.className = 'border rounded-lg shadow-sm p-4 bg-white';
                        
                        // Costruisci la lista delle cialde
                        let cialdeHTML = '';
                        if (bevanda.cialde && bevanda.cialde.length > 0) {
                            cialdeHTML = `
                                <div class="mt-2">
                                    <h4 class="font-medium text-sm text-gray-600 mb-1">Composizione:</h4>
                                    <ul class="list-disc list-inside text-sm">
                                        ${bevanda.cialde.map(cialda => `
                                            <li class="ml-2">${cialda.nome} (${cialda.tipoCialda})</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-bold text-blue-600">${bevanda.nome}</h3>
                                    <p class="text-gray-600">Prezzo: €${bevanda.prezzo.toFixed(2)}</p>
                                </div>
                                <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                                    <i class="fas fa-check-circle mr-1"></i>Disponibile
                                </span>
                            </div>
                            ${cialdeHTML}
                        `;
                        
                        bevandeList.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading bevande:', error);
                    bevandeList.innerHTML = '<div class="text-center text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Errore nel caricamento delle bevande</div>';
                });
        }

        function loadCialde() {
            const cialdeList = document.getElementById('cialdeList');
            cialdeList.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Caricamento...</div>';
            
            axios.get(`${API_BASE_URL}/admin/cialde`)
                .then(response => {
                    const cialde = response.data;
                    cialdeList.innerHTML = '';
                    
                    if (!cialde || cialde.length === 0) {
                        // Poiché non abbiamo l'API per le cialde, mostreremo dati di esempio
                        const exampleCialde = [
                            { nome: "Arabica", tipoCialda: "Caffè" },
                            { nome: "Robusta", tipoCialda: "Caffè" },
                            { nome: "Te verde", tipoCialda: "Tè" },
                            { nome: "Cioccolato", tipoCialda: "Cacao" },
                            { nome: "Ginseng", tipoCialda: "Caffè" },
                            { nome: "Zucchero", tipoCialda: "Additivo" },
                            { nome: "Latte", tipoCialda: "Additivo" }
                        ];
                        
                        renderCialdeList(exampleCialde);
                        return;
                    }
                    
                    // Se abbiamo dati dall'API, li usiamo
                    renderCialdeList(cialde);
                })
                .catch(error => {
                    console.error('Error loading cialde:', error);
                    
                    // Fallback a dati di esempio in caso di errore
                    const exampleCialde = [
                        { nome: "Arabica", tipoCialda: "Caffè" },
                        { nome: "Robusta", tipoCialda: "Caffè" },
                        { nome: "Te verde", tipoCialda: "Tè" },
                        { nome: "Cioccolato", tipoCialda: "Cacao" },
                        { nome: "Ginseng", tipoCialda: "Caffè" },
                        { nome: "Zucchero", tipoCialda: "Additivo" },
                        { nome: "Latte", tipoCialda: "Additivo" }
                    ];
                    
                    renderCialdeList(exampleCialde);
                });
        }

        function renderCialdeList(cialde) {
            const cialdeList = document.getElementById('cialdeList');
            cialdeList.innerHTML = '';
            
            if (!cialde || cialde.length === 0) {
                cialdeList.innerHTML = '<div class="text-center text-gray-500">Nessuna cialda disponibile</div>';
                return;
            }
            
            // Raggruppa le cialde per tipo
            const cialdeByType = {};
            cialde.forEach(cialda => {
                if (!cialdeByType[cialda.tipoCialda]) {
                    cialdeByType[cialda.tipoCialda] = [];
                }
                cialdeByType[cialda.tipoCialda].push(cialda);
            });
            
            // Crea un contenitore per ogni tipo di cialda
            Object.keys(cialdeByType).forEach(tipo => {
                const tipoContainer = document.createElement('div');
                tipoContainer.className = 'mb-6';
                
                let iconClass = 'coffee';
                switch (tipo.toLowerCase()) {
                    case 'tè':
                    case 'te':
                        iconClass = 'mug-hot';
                        break;
                    case 'cacao':
                        iconClass = 'cookie';
                        break;
                    case 'additivo':
                        iconClass = 'plus-circle';
                        break;
                }
                
                tipoContainer.innerHTML = `
                    <h3 class="text-md font-bold mb-3 px-2 py-1 bg-gray-100 rounded flex items-center">
                        <i class="fas fa-${iconClass} mr-2"></i>${tipo}
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="cialde-${tipo.replace(/\s+/g, '-').toLowerCase()}">
                    </div>
                `;
                
                cialdeList.appendChild(tipoContainer);
                
                const cialdeGrid = document.getElementById(`cialde-${tipo.replace(/\s+/g, '-').toLowerCase()}`);
                
                // Aggiungi le cialde al contenitore del loro tipo
                cialdeByType[tipo].forEach(cialda => {
                    const card = document.createElement('div');
                    card.className = 'border rounded-lg p-3 bg-white flex items-center';
                    
                    let statusClass = 'bg-green-100 text-green-800';
                    let statusText = 'Disponibile';
                    let quantitaText = '';
                    
                    // Se abbiamo informazioni sulla quantità
                    if (cialda.quantita !== undefined && cialda.quantitaMassima !== undefined) {
                        const percentuale = (cialda.quantita / cialda.quantitaMassima) * 100;
                        quantitaText = `
                            <div class="mt-1">
                                <div class="text-xs text-gray-500">Quantità: ${cialda.quantita}/${cialda.quantitaMassima}</div>
                                <div class="mt-1 bg-gray-200 rounded-full h-1.5">
                                    <div class="bg-blue-600 h-1.5 rounded-full" style="width: ${percentuale}%"></div>
                                </div>
                            </div>
                        `;
                        
                        if (percentuale < 20) {
                            statusClass = 'bg-red-100 text-red-800';
                            statusText = 'Scorta bassa';
                        } else if (percentuale < 50) {
                            statusClass = 'bg-yellow-100 text-yellow-800';
                            statusText = 'In esaurimento';
                        }
                    }
                    
                    card.innerHTML = `
                        <div class="flex-grow">
                            <h4 class="font-medium">${cialda.nome}</h4>
                            ${quantitaText}
                        </div>
                        <span class="${statusClass} px-2 py-1 rounded text-xs font-medium ml-2">
                            ${statusText}
                        </span>
                    `;
                    
                    cialdeGrid.appendChild(card);
                });
            });
        }
        
        function showFinanzeTab(tabName) {
            // Nascondi tutti i contenuti dei tab
            document.querySelectorAll('.finanze-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Rimuovi la classe attiva da tutti i tab
            document.querySelectorAll('.finanze-tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600', 'border-b-2');
                btn.classList.add('border-transparent');
            });

            // Mostra il tab selezionato
            document.getElementById(tabName + 'Tab').classList.remove('hidden');
            document.querySelector(`.finanze-tab-btn[data-tab="${tabName}"]`).classList.add('text-blue-600', 'border-blue-600', 'border-b-2');
            document.querySelector(`.finanze-tab-btn[data-tab="${tabName}"]`).classList.remove('border-transparent');

            // Carica i dati se necessario
            if (tabName === 'tutte') {
                loadTutteTransazioni();
            } else{
                loadMacchinePerTransazioni();
            }
        }

        // Funzione per caricare tutte le transazioni
        function loadTutteTransazioni() {
            const tutteTransazioniList = document.getElementById('tutteTransazioniList');
            tutteTransazioniList.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Caricamento...</div>';

            axios.get(`${API_BASE_URL}/admin/transazioni`)
                .then(response => {
                    const transazioni = response.data || [];
                    tutteTransazioniList.innerHTML = '';

                    if (transazioni.length === 0) {
                        tutteTransazioniList.innerHTML = '<div class="text-center text-gray-500">Nessuna transazione disponibile</div>';
                        return;
                    }

                    transazioni.forEach(transazione => {
                        const card = document.createElement('div');
                        card.className = 'border rounded-lg shadow-sm p-4 bg-white';
                        card.innerHTML = `
                            <div class="flex justify-between">
                                <span class="font-medium">Transazione #${transazione.id}</span>
                                <span class="text-green-600">€${transazione.importo.toFixed(2)}</span>
                            </div>
                            <div class="text-sm text-gray-600">Macchina #${transazione.macchinaId}</div>
                            <div class="text-sm text-gray-600">Data: ${new Date(transazione.dataOra).toLocaleString()}</div>
                        `;
                        tutteTransazioniList.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading tutte transazioni:', error);
                    tutteTransazioniList.innerHTML = '<div class="text-center text-red-500">Errore nel caricamento delle transazioni</div>';
                });
        }

        

        // Funzione per caricare le macchine per le transazioni
        function loadMacchinePerTransazioni() {
            const macchinaSelect = document.getElementById('macchinaSelect');
            const macchinaTransazioniList = document.getElementById('macchinaTransazioniList');

            // Carica le macchine disponibili
            axios.get(`${API_BASE_URL}/macchine`)
                .then(response => {
                    const macchine = response.data || [];
                    macchinaSelect.innerHTML = '<option value="">Seleziona una macchina</option>';

                    macchine.forEach(macchina => {
                        const option = document.createElement('option');
                        option.value = macchina.id;
                        option.textContent = `Macchina #${macchina.id} - ${macchina.nomeIstituto}`;
                        macchinaSelect.appendChild(option);
                    });

                    // Aggiungi un listener per il cambio di selezione
                    macchinaSelect.addEventListener('change', (event) => {
                        const macchinaId = event.target.value;
                        if (macchinaId) {
                            loadTransazioniPerMacchina(macchinaId);
                        } else {
                            macchinaTransazioniList.innerHTML = '<div class="text-center text-gray-500">Seleziona una macchina per vedere le transazioni.</div>';
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading macchine:', error);
                    macchinaSelect.innerHTML = '<option value="">Errore nel caricamento delle macchine</option>';
                });
        }

        // Funzione per caricare le transazioni per una macchina specifica
        function loadTransazioniPerMacchina(macchinaId) {
            const macchinaTransazioniList = document.getElementById('macchinaTransazioniList');
            macchinaTransazioniList.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Caricamento...</div>';

            axios.get(`${API_BASE_URL}/admin/transazioni/macchina/${macchinaId}`)
                .then(response => {
                    const transazioni = response.data || [];
                    macchinaTransazioniList.innerHTML = '';

                    if (transazioni.length === 0) {
                        macchinaTransazioniList.innerHTML = '<div class="text-center text-gray-500">Nessuna transazione per questa macchina</div>';
                        return;
                    }

                    transazioni.forEach(transazione => {
                        const card = document.createElement('div');
                        card.className = 'border rounded-lg shadow-sm p-4 bg-white';
                        card.innerHTML = `
                            <div class="flex justify-between">
                                <span class="font-medium">Transazione #${transazione.id}</span>
                                <span class="text-green-600">€${transazione.importo.toFixed(2)}</span>
                            </div>
                            <div class="text-sm text-gray-600">Data: ${new Date(transazione.dataOra).toLocaleString()}</div>
                        `;
                        macchinaTransazioniList.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('Error loading transazioni per macchina:', error);
                    macchinaTransazioniList.innerHTML = '<div class="text-center text-red-500">Errore nel caricamento delle transazioni</div>';
                });
        }

        // Inizializzazione della sezione finanze
        function loadFinanze() {
            showFinanzeTab('tutte'); // Mostra il tab "Tutte le transazioni" di default
        }

        
        function loadUtenti() {
            axios.get(`${API_BASE_URL}/admin/utenti`)
                .then(response => {
                    const utenti = response.data;
                    const tbody = document.getElementById('utentiList');
                    tbody.innerHTML = '';

                    utenti.forEach(utente => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        	
                            <td class="py-2">${utente.nome}</td>
                            <td class="py-2">${utente.ruolo}</td>
                            <td class="py-2">${utente.ultimoAccesso}</td>
                            <td class="py-2">
                                <button onclick="editUtente(${utente.id})" class="text-blue-500 hover:text-blue-700 mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteUtente(${utente.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading utenti:', error);
                    alert('Errore nel caricamento degli utenti');
                });
        }
        
        function addUser() {
            const nome = document.getElementById('nomeUtente').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const ruolo = document.getElementById('ruoloSelect').value;

            if (!nome || !username || !password || !ruolo) {
                alert('Compilare tutti i campi');
                return;
            }

            axios.post(`${API_BASE_URL}/admin/utenti`, { nome, username, password, ruolo })
                .then(() => {
                    hideModal('addUserModal');
                    loadUtenti();
                })
                .catch(error => {
                    console.error('Error adding user:', error);
                    alert('Errore nell\'aggiunta dell\'utente');
                });
        }
        
        function editUtente(id) {
            const nome = prompt('Nuovo nome utente:');
            const ruolo = prompt('Nuovo ruolo (Amministratore, Tecnico, Operatore):');

            if (nome && ruolo) {
                axios.put(`${API_BASE_URL}/admin/utenti/${id}`, { nome, ruolo })
                    .then(() => {
                        loadUtenti();
                    })
                    .catch(error => {
                        console.error('Error updating user:', error);
                        alert('Errore nell\'aggiornamento dell\'utente');
                    });
            }
        }
        
        function deleteUtente(id) {
            if (confirm('Sei sicuro di voler eliminare questo utente?')) {
                axios.delete(`${API_BASE_URL}/admin/utenti/${id}`)
                    .then(() => {
                        loadUtenti();
                    })
                    .catch(error => {
                        console.error('Error deleting user:', error);
                        alert('Errore nell\'eliminazione dell\'utente');
                    });
            }
        }
        function getStatoClass(statoId) {
            switch(statoId) {
                case 1: return 'bg-green-100 text-green-800'; // Attiva
                case 2: return 'bg-yellow-100 text-yellow-800'; // In manutenzione
                case 3: return 'bg-red-100 text-red-800'; // Fuori servizio
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        function renderEmptyChart(canvasId, message) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Nessun dato'],
                    datasets: [{
                        label: 'Dati non disponibili',
                        data: [0],
                        backgroundColor: 'rgba(200, 200, 200, 0.2)',
                        borderColor: 'rgba(200, 200, 200, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                display: false
                            },
                            grid: {
                                display: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'emptyMessage',
                    afterDraw: (chart) => {
                        const ctx = chart.ctx;
                        const width = chart.width;
                        const height = chart.height;
                        
                        ctx.save();
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = '14px Arial';
                        ctx.fillStyle = '#666';
                        ctx.fillText(message, width / 2, height / 2);
                        ctx.restore();
                    }
                }]
            });
        }
        
        function loadMonitoraggio() {
            // Carica le macchine e il loro stato
            axios.get(`${API_BASE_URL}/macchine`)
                .then(response => {
                    const macchine = Array.isArray(response.data) ? response.data : [];
                    const statoSistemaDiv = document.getElementById('statoSistema');
                    
                    if (macchine.length === 0) {
                        statoSistemaDiv.innerHTML = '<div class="text-gray-500">Nessuna macchina disponibile</div>';
                        renderEmptyChart('performanceChart', 'Nessuna macchina disponibile');
                        return;
                    }
                    
                    // Calcola lo stato generale del sistema
                    const totale = macchine.length;
                    const attive = macchine.filter(m => m.statoId === 1).length;
                    const inManutenzione = macchine.filter(m => m.statoId === 2).length;
                    const fuoriServizio = macchine.filter(m => m.statoId === 3).length;
                    
                    const percentualeAttive = totale > 0 ? (attive / totale * 100).toFixed(0) : 0;
                    
                    const statoClasse = percentualeAttive > 80 ? 'text-green-600' : 
                                       percentualeAttive > 50 ? 'text-yellow-600' : 'text-red-600';
                    
                    const statoDescrizione = percentualeAttive > 80 ? 
                        "Sistema funzionante correttamente" : 
                        percentualeAttive > 50 ? 
                            "Sistema parzialmente funzionante" : 
                            "Sistema compromesso";
                    
                    statoSistemaDiv.innerHTML = `
                        <div class="flex items-center mb-4">
                            <div class="w-16 h-16 rounded-full flex items-center justify-center ${statoClasse} bg-gray-100 mr-4">
                                <span class="text-2xl font-bold">${percentualeAttive}%</span>
                            </div>
                            <div>
                                <div class="text-lg font-medium">${statoDescrizione}</div>
                                <div class="text-gray-600 text-sm">${attive} macchine attive su ${totale}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-green-100 p-2 rounded">
                                <div class="text-green-600 font-bold">${attive}</div>
                                <div class="text-sm">Attive</div>
                            </div>
                            <div class="bg-yellow-100 p-2 rounded">
                                <div class="text-yellow-600 font-bold">${inManutenzione}</div>
                                <div class="text-sm">In Manutenzione</div>
                            </div>
                            <div class="bg-red-100 p-2 rounded">
                                <div class="text-red-600 font-bold">${fuoriServizio}</div>
                                <div class="text-sm">Fuori Servizio</div>
                            </div>
                        </div>
                    `;
                    
                    // Crea il grafico delle performance
                    const perfCtx = document.getElementById('performanceChart').getContext('2d');
                    new Chart(perfCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Attive', 'In Manutenzione', 'Fuori Servizio'],
                            datasets: [{
                                data: [attive, inManutenzione, fuoriServizio],
                                backgroundColor: [
                                    'rgb(34, 197, 94)',
                                    'rgb(234, 179, 8)',
                                    'rgb(239, 68, 68)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw;
                                            const percentage = Math.round((value / totale) * 100);
                                            return `${context.label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            },
                            cutout: '60%'
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading macchine:', error);
                    const statoSistemaDiv = document.getElementById('statoSistema');
                    statoSistemaDiv.innerHTML = '<div class="text-red-500">Errore nel caricamento dello stato del sistema</div>';
                    renderEmptyChart('performanceChart', 'Errore nel caricamento dei dati');
                });

            // Carica le manutenzioni attive (allarmi)
            axios.get(`${API_BASE_URL}/manutenzione`)
                .then(response => {
                    const manutenzioni = Array.isArray(response.data) ? 
                        response.data.filter(m => m.stato !== "COMPLETATA") : [];
                    
                    const allarmiList = document.getElementById('allarmiList');
                    allarmiList.innerHTML = '';

                    if (manutenzioni.length === 0) {
                        allarmiList.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                                <div class="text-green-600">Nessun allarme attivo</div>
                            </div>
                        `;
                        return;
                    }

                    manutenzioni.forEach(manutenzione => {
                        // Verifica che i dati esistano prima di usarli
                        const urgenza = manutenzione.urgenza || 'BASSA';
                        const tipoIntervento = manutenzione.tipoIntervento || 'Manutenzione generica';
                        const descrizione = manutenzione.descrizione || 'Nessuna descrizione';
                        
                        let borderClass = 'border-blue-500 bg-blue-50';
                        if (urgenza === 'ALTA') {
                            borderClass = 'border-red-500 bg-red-50';
                        } else if (urgenza === 'MEDIA') {
                            borderClass = 'border-yellow-500 bg-yellow-50';
                        }
                        
                        const div = document.createElement('div');
                        div.className = `mb-3 p-3 border-l-4 ${borderClass}`;
                        
                        let dataRichiesta = 'Data non disponibile';
                        if (manutenzione.dataRichiesta) {
                            try {
                                const data = new Date(manutenzione.dataRichiesta);
                                if (!isNaN(data.getTime())) {
                                    dataRichiesta = data.toLocaleString();
                                }
                            } catch (e) {
                                console.error('Errore nella formattazione della data:', e);
                            }
                        }
                        
                        div.innerHTML = `
                            <div class="flex justify-between">
                                <span class="font-medium">Macchina #${manutenzione.macchinaId || 'N/D'}</span>
                                <span class="text-sm font-medium ${urgenza === 'ALTA' ? 'text-red-600' : 
                                                 urgenza === 'MEDIA' ? 'text-yellow-600' : 'text-blue-600'}">
                                    ${urgenza}
                                </span>
                            </div>
                            <div class="text-gray-800">${tipoIntervento}</div>
                            <div class="text-sm text-gray-600 mt-1">${descrizione}</div>
                            <div class="text-xs text-gray-500 mt-2">
                                Richiesta: ${dataRichiesta}
                            </div>
                        `;
                        allarmiList.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Error loading allarmi:', error);
                    const allarmiList = document.getElementById('allarmiList');
                    allarmiList.innerHTML = '<div class="text-red-500">Errore nel caricamento degli allarmi</div>';
                });
        }

        // Initialize Charts
        function initCharts() {
            // Ricavi Chart
            const ricaviCtx = document.getElementById('ricaviChart').getContext('2d');
            new Chart(ricaviCtx, {
                type: 'line',
                data: {
                    labels: ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu'],
                    datasets: [{
                        label: 'Ricavi Mensili',
                        data: [12000, 19000, 15000, 17000, 22000, 20000],
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Attive', 'In Manutenzione', 'Fuori Servizio'],
                    datasets: [{
                        data: [75, 15, 10],
                        backgroundColor: [
                            'rgb(34, 197, 94)',
                            'rgb(234, 179, 8)',
                            'rgb(239, 68, 68)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            showTab('istituti');
            initCharts();

            document.getElementById('saveMacchinaBtn').addEventListener('click', addMacchina);
            document.getElementById('saveUserBtn').addEventListener('click', addUser);
        });
    </script>
</body>
</html>