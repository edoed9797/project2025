<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Amministratore - Sistema Distributori</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
    .status-available {
	    background-color: green;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}
	
	.status-maintenance {
	    background-color: yellow;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}
	
	.status-inactive {
	    background-color: #fd0006;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}
	
	.status-unknown {
	    background-color: gray;
	    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}
	.status-badge {
	    display: inline-block;
	    width: 12px;
	    height: 12px;
	    border-radius: 50%;
	    margin-right: 8px;
	}
    </style>
</head>
<body class="bg-gray-100">
    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4" style="background-color:grey">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold" >Dashboard Amministratore</h1> 
            <div>
                <span id="userInfo" class="mr-3"></span>
                <button onclick="window.location.href = '/index.html'" class="bg-blue-500 px-3 py-2 rounded hover:bg-blue-600">
                    Home
                </button>
               </div>
               <div>
                <button onclick="window.location.href = '/spegni'" class="btn btn-danger">
                    <i class="fa-solid fa-power-off"></i>
                </button>
                
            </div>
               <div>
                <span id="userInfo" class="user-info">
                <span id="userName"></span>
                    <i class="fas fa-user"></i>
                </span>
                <button onclick="logout()" class="bg-red-500 px-3 py-2 rounded hover:bg-red-600">
                    Logout
                </button>
            </div>
        </div>
    </nav>
    
    

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Navigation Tabs -->
        <div class="mb-4 border-b border-gray-200">
            <ul class="flex flex-wrap -mb-px" id="myTab">
                <li class="mr-2">
                    <button onclick="showTab('istituti')" class="tab-btn inline-block p-4" data-tab="istituti">
                        <i class="fas fa-building mr-2"></i>Istituti
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('macchine')" class="tab-btn inline-block p-4" data-tab="macchine">
                        <i class="fas fa-coffee mr-2"></i>Macchine
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('magazzino')" class="tab-btn inline-block p-4" data-tab="magazzino">
                        <i class="fas fa-warehouse mr-2"></i>Magazzino
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('finanze')" class="tab-btn inline-block p-4" data-tab="finanze">
                        <i class="fas fa-chart-line mr-2"></i>Finanze
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('utenti')" class="tab-btn inline-block p-4" data-tab="utenti">
                        <i class="fas fa-users mr-2"></i>Utenti
                    </button>
                </li>
                <li class="mr-2">
                    <button onclick="showTab('monitoraggio')" class="tab-btn inline-block p-4" data-tab="monitoraggio">
                        <i class="fas fa-desktop mr-2"></i>Monitoraggio
                    </button>
                </li>
            </ul>
        </div>

        <!-- Tab Contents -->
        <div id="tabContents">
            <!-- Istituti Tab -->
            <div id="istituti" class="tab-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">Gestione Istituti</h2>
                    <button onclick="showModal('addIstitutoModal')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Nuovo Istituto
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2">Nome</th>
                                <th class="text-left py-2">Indirizzo</th>
                                <th class="text-left py-2">Macchine</th>
                                <th class="text-left py-2">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="istitutiList">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Macchine Tab -->
            <div id="macchine" class="tab-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">Gestione Macchine</h2>
                    <button onclick="showModal('addMacchinaModal')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Nuova Macchina
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2">ID</th>
                                <th class="text-left py-2">Istituto</th>
                                <th class="text-left py-2">Stato</th>
                                <th class="text-left py-2">Incasso</th>
                                <th class="text-left py-2">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="macchineList">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Magazzino Tab -->
            <div id="magazzino" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Scorte Cialde</h3>
                        <div id="scorteCialde"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Rifornimenti Necessari</h3>
                        <div id="rifornimentiList"></div>
                    </div>
                </div>
            </div>

            <!-- Finanze Tab -->
            <div id="finanze" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Ricavi Totali</h3>
                        <canvas id="ricaviChart"></canvas>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Transazioni Recenti</h3>
                        <div id="transazioniList"></div>
                    </div>
                </div>
            </div>

            <!-- Utenti Tab -->
            <div id="utenti" class="tab-content hidden">
                <div class="flex justify-between mb-4">
                    <h2 class="text-xl font-bold">Gestione Utenti</h2>
                    <button onclick="showModal('addUserModal')" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        <i class="fas fa-plus mr-2"></i>Nuovo Utente
                    </button>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <table class="min-w-full">
                        <thead>
                            <tr>
                                <th class="text-left py-2">Nome</th>
                                <th class="text-left py-2">Ruolo</th>
                                <th class="text-left py-2">Ultimo Accesso</th>
                                <th class="text-left py-2">Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="utentiList">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Monitoraggio Tab -->
            <div id="monitoraggio" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Stato Sistema</h3>
                        <div id="statoSistema"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Allarmi Attivi</h3>
                        <div id="allarmiList"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="text-lg font-bold mb-4">Performance</h3>
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Istituto Modal -->
    <div id="addIstitutoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Aggiungi Nuovo Istituto</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" id="nomeIstituto" placeholder="Nome Istituto" class="mb-3 px-3 py-2 border rounded w-full">
                    <input type="text" id="indirizzoIstituto" placeholder="Indirizzo" class="mb-3 px-3 py-2 border rounded w-full">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveIstitutoBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Salva
                    </button>
                    <button onclick="hideModal('addIstitutoModal')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Macchina Modal -->
    <div id="addMacchinaModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Aggiungi Nuova Macchina</h3>
                <div class="mt-2 px-7 py-3">
                    <select id="istitutoSelect" class="mb-3 px-3 py-2 border rounded w-full">
                        <!-- Populated by JavaScript -->
                    </select>
                    <input type="number" id="cassaMassima" placeholder="Capacità Cassa" class="mb-3 px-3 py-2 border rounded w-full">
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveMacchinaBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Salva
                    </button>
                    <button onclick="hideModal('addMacchinaModal')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Aggiungi Nuovo Utente</h3>
                <div class="mt-2 px-7 py-3">
                    <input type="text" id="nomeUtente" placeholder="Nome" class="mb-3 px-3 py-2 border rounded w-full">
                    <input type="text" id="username" placeholder="Username" class="mb-3 px-3 py-2 border rounded w-full">
                    <input type="password" id="password" placeholder="Password" class="mb-3 px-3 py-2 border rounded w-full">
                    <select id="ruoloSelect" class="mb-3 px-3 py-2 border rounded w-full">
                        <option value="Amministratore">Amministratore</option>
                        <option value="Tecnico">Tecnico</option>
                        <option value="Operatore">Operatore</option>
                    </select>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="saveUserBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Salva
                    </button>
                    <button onclick="hideModal('addUserModal')" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                        Annulla
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const userInfo = document.getElementById('userInfo');
    const userNameSpan = document.getElementById('userName');
    userNameSpan.textContent = localStorage.getItem('user_name');
        // API Configuration
        const API_BASE_URL = 'https://localhost:8443/api';
        let currentUser = null;
        let currentTab = 'istituti';

        // Check Authentication
        function checkAuth() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                window.location.href = '/index.html';
                return;
            }
            
            // Set authorization header for all requests
            axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
            
        }

        // Logout Function
        function logout() {
            localStorage.removeItem('jwt_token');
            window.location.href = '/index.html';
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600', 'border-b-2');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('text-blue-600', 'border-blue-600', 'border-b-2');
            
            currentTab = tabName;
            loadTabData(tabName);
        }

        // Modal Management
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Load Tab Data
        function loadTabData(tabName) {
            switch(tabName) {
                case 'istituti':
                    loadIstituti();
                    break;
                case 'macchine':
                    loadMacchine();
                    break;
                case 'magazzino':
                    loadMagazzino();
                    break;
                case 'finanze':
                    loadFinanze();
                    break;
                case 'utenti':
                    loadUtenti();
                    break;
                case 'monitoraggio':
                    loadMonitoraggio();
                    break;
            }
        }

        // Funzione per caricare gli istituti con la funzionalità espandibile
      function loadIstituti() {
    axios.get(`${API_BASE_URL}/istituti`)
        .then(response => {
            const istituti = response.data;
            const tbody = document.getElementById('istitutiList');
            tbody.innerHTML = '';
            
            istituti.forEach(istituto => {
            	console.log(istituto);
                const macchine = istituto.macchine ? istituto.macchine.length : 0;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">${istituto.nome}</td>
                    <td class="py-2">${istituto.indirizzo}</td>
                    <td class="py-2">
                        <button onclick="toggleMacchineIstituto(${istituto.ID_istituto})" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="fa-solid fa-eye"></i> ${macchine}
                        </span>
                    </td>
                    <td class="py-2">
                        <button onclick="editIstituto(${istituto.ID_istituto})" class="text-blue-500 hover:text-blue-700 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteIstituto(${istituto.ID_istituto})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Creiamo una riga nascosta per il contenuto espandibile
                const contentRow = document.createElement('tr');
                contentRow.id = `istituto-macchine-${istituto.ID_istituto}`;
                contentRow.className = 'hidden';
                contentRow.innerHTML = `
                    <td colspan="4" class="py-2 px-4 bg-gray-50">

                        <div id="macchine-list-${istituto.ID_istituto}" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="text-center text-gray-500">Caricamento...</div>
                        </div>
                    </td>
                `;
                tbody.appendChild(contentRow);
            });
        })
        .catch(error => {
            console.error('Error loading istituti:', error);
            alert('Errore nel caricamento degli istituti');
        });
}

function toggleMacchineIstituto(istitutoId) {
    const contentRow = document.getElementById(`istituto-macchine-${istitutoId}`);
    const macchineList = document.getElementById(`macchine-list-${istitutoId}`);

    if (contentRow.classList.contains('hidden')) {
        // Se la riga è nascosta, la mostriamo e carichiamo le macchine
        contentRow.classList.remove('hidden');
        loadMacchineIstituto(istitutoId, macchineList);
    } else {
        // Se la riga è visibile, la nascondiamo
        contentRow.classList.add('hidden');
    }
}

function loadMacchineIstituto(istitutoId, macchineList) {
    axios.get(`${API_BASE_URL}/istituti/${istitutoId}/macchine`)
        .then(response => {
            const macchine = response.data;
            macchineList.innerHTML = ''; // Svuotiamo il contenuto di caricamento

            if (macchine.length === 0) {
                macchineList.innerHTML = '<div class="text-center text-gray-500">Nessuna macchina disponibile</div>';
            } else {
                macchine.forEach(machine => {
                    const macchinaDiv = document.createElement('div');
                    macchinaDiv.className = 'bg-white p-4 rounded-lg shadow';
                    macchinaDiv.innerHTML = `
                        <div class="machine-card" onclick="showMacchinaDetails(${machine.id})" data-toggle="tooltip" data-placement="top" title="Clicca per vedere le informazioni sulla macchina">
                        <div class="machine-header">
                        <div class="status-badge ${getStatusClass(machine.statoId)}"></div>
                            <div><h4><b>ID Macchina: #${machine.id}</b> </h4></div>
                        </div>
                        <div class="machine-info">
                            <p>Stato: ${machine.statoDescrizione}</p>
                            <p>Cassa: €${machine.cassaAttuale.toFixed(2)} / €${machine.cassaMassima.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                    macchineList.appendChild(macchinaDiv);
                });
            }
        })
        .catch(error => {
            console.error('Error loading macchine:', error);
            macchineList.innerHTML = '<div class="text-center text-red-500">Errore nel caricamento delle macchine</div>';
        });
}

function getStatusClass (statoId) {
    const classi = {
            1: 'status-available',
            2: 'status-maintenance',
            3: 'status-inactive'
        };
        return classi[statoId] || 'status-unknown';
    }

        // Save Istituto
        document.getElementById('saveIstitutoBtn').addEventListener('click', () => {
            const nome = document.getElementById('nomeIstituto').value;
            const indirizzo = document.getElementById('indirizzoIstituto').value;
            if (!nome || !indirizzo) {
                alert('Compilare tutti i campi');
                return;
            }
            
            axios.post(`${API_BASE_URL}/admin/istituti`, { nome, indirizzo })
                .then(() => {
                    hideModal('addIstitutoModal');
                    loadIstituti();
                })
                .catch(error => {
                    console.error('Error saving istituto:', error);
                    alert('Errore nel salvataggio dell\'istituto');
                });
        });

        // Machine Management
        function loadMacchine() {
            axios.get(`${API_BASE_URL}/macchine`)
                .then(response => {
                    const macchine = response.data;
                    const tbody = document.getElementById('macchineList');
                    tbody.innerHTML = '';
                    
                    macchine.forEach(macchina => {
                        const row = document.createElement('tr');
                        row.className = 'cursor-pointer hover:bg-gray-50';
                        row.onclick = () => showMacchinaDetails(macchina.id);
                        row.innerHTML = `
                            <td class="py-2">${macchina.id}</td>
                            <td class="py-2">${macchina.nomeIstituto}</td>
                            <td class="py-2">
                                <span class="px-2 py-1 rounded ${getStatoClass(macchina.statoId)}">
                                    ${macchina.statoDescrizione}
                                </span>
                            </td>
                            <td class="py-2">€${macchina.cassaAttuale.toFixed(2)}</td>
                            <td class="py-2" onclick="event.stopPropagation()">
                                <button onclick="configuraMacchina(${macchina.id})" class="text-blue-500 hover:text-blue-700 mr-2">
                                    <i class="fas fa-cog"></i>
                                </button>
                                <button onclick="deleteMacchina(${macchina.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading macchine:', error);
                    alert('Errore nel caricamento delle macchine');
                });
        }

        // Funzione per mostrare i dettagli di una macchina in un modal
        function showMacchinaDetails(macchinaId) {
            // Assicuriamoci che esista un modal per i dettagli della macchina
            if (!document.getElementById('macchinaDetailsModal')) {
                const modal = document.createElement('div');
                modal.id = 'macchinaDetailsModal';
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center';
                modal.innerHTML = `
                    <div class="relative mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                        <div class="flex justify-between items-center border-b pb-3">
                            <h3 class="text-lg font-medium text-gray-900" id="macchinaDetailsTitle">Dettagli Macchina</h3>
                            <button onclick="hideModal('macchinaDetailsModal')" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="macchinaDetailsContent" class="mt-4">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i>
                                <p>Caricamento...</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Mostriamo il modal
            showModal('macchinaDetailsModal');
            
            // Carichiamo i dettagli della macchina
            axios.get(`${API_BASE_URL}/macchine/${macchinaId}`)
                .then(response => {
                    const macchina = response.data;
                    const contentDiv = document.getElementById('macchinaDetailsContent');
                    const title = document.getElementById('macchinaDetailsTitle');
                    
                    title.textContent = `Dettagli Macchina #${macchina.id}`;
                    
                    // Organizziamo i dati in sezioni
                    let bevandeHtml = '';
                    if (macchina.bevande && macchina.bevande.length > 0) {
                        bevandeHtml = `
                            <div class="mt-4">
                                <h4 class="font-medium text-gray-700 mb-2">Bevande Disponibili</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${macchina.bevande.map(bevanda => `
                                        <div class="border rounded p-2 bg-gray-50">
                                            <div class="font-medium">${bevanda.nome}</div>
                                            <div class="text-sm">Prezzo: €${bevanda.prezzo.toFixed(2)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    let cialdeHtml = '';
                    if (macchina.cialde && macchina.cialde.length > 0) {
                        cialdeHtml = `
                            <div class="mt-4">
                                <h4 class="font-medium text-gray-700 mb-2">Stato Cialde</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${macchina.cialde.map(cialda => `
                                        <div class="border rounded p-2 bg-gray-50">
                                            <div class="font-medium">${cialda.nomeCialda || 'Cialda #' + cialda.cialdaId}</div>
                                            <div class="text-sm">Quantità: ${cialda.quantita}/${cialda.quantitaMassima}</div>
                                            <div class="mt-1 bg-gray-200 rounded-full h-2.5">
                                                <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${(cialda.quantita/cialda.quantitaMassima*100).toFixed(0)}%"></div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                    
                    // Componiamo il contenuto completo
                    contentDiv.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">Informazioni Generali</h4>
                                <table class="min-w-full text-sm">
                                    <tr>
                                        <td class="py-1 font-medium">ID:</td>
                                        <td>${macchina.id}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Istituto:</td>
                                        <td>${macchina.nomeIstituto}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Stato:</td>
                                        <td>
                                            <span class="px-2 py-1 rounded ${getStatoClass(macchina.statoId)}">
                                                ${macchina.statoDescrizione}
                                            </span>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-700 mb-2">Stato Cassa</h4>
                                <table class="min-w-full text-sm">
                                    <tr>
                                        <td class="py-1 font-medium">Credito Attuale:</td>
                                        <td>€${macchina.creditoAttuale.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Cassa Attuale:</td>
                                        <td>€${macchina.cassaAttuale.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Capacità Cassa:</td>
                                        <td>€${macchina.cassaMassima.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 font-medium">Riempimento:</td>
                                        <td>
                                            <div class="mt-1 bg-gray-200 rounded-full h-2.5">
                                                <div class="bg-green-600 h-2.5 rounded-full" 
                                                    style="width: ${(macchina.cassaAttuale/macchina.cassaMassima*100).toFixed(0)}%"></div>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        ${bevandeHtml}
                        ${cialdeHtml}
                        
                        <div class="mt-6 text-right">
                            <button onclick="configuraMacchina(${macchina.id})" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                <i class="fas fa-cog mr-2"></i>Cambia stato
                            </button>
                            <button onclick="hideModal('macchinaDetailsModal')" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                                Chiudi
                            </button>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('Error loading macchina details:', error);
                    const contentDiv = document.getElementById('macchinaDetailsContent');
                    contentDiv.innerHTML = `
                        <div class="text-center text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Errore nel caricamento dei dettagli della macchina.</p>
                        </div>
                    `;
                });
        }
        
        // Add macchina
        function addMacchina() {
    		const istitutoId = document.getElementById('istitutoSelect').value;
    		const cassaMassima = document.getElementById('cassaMassima').value;

		    if (!istitutoId || !cassaMassima) {
		        alert('Compilare tutti i campi');
		        return;
		    }
		
		    axios.post(`${API_BASE_URL}/admin/macchine`, { istitutoId, cassaMassima })
		        .then(() => {
		            hideModal('addMacchinaModal');
		            loadMacchine();
		        })
		        .catch(error => {
		            console.error('Error adding machine:', error);
		            alert('Errore nell\'aggiunta della macchina');
		        });
		}
        
        // Modifica stato macchina
        function updateStatoMacchina(id, statoId) {
		    axios.put(`${API_BASE_URL}/admin/macchine/${id}/stato`, { statoId })
		        .then(() => {
		            loadMacchine();
		        })
		        .catch(error => {
		            console.error('Error updating machine status:', error);
		            alert('Errore nell\'aggiornamento dello stato della macchina');
		        });
		}
        
        // Delete macchina
        function deleteMacchina(id) {
		    if (confirm('Sei sicuro di voler eliminare questa macchina?')) {
		        axios.delete(`${API_BASE_URL}/admin/macchine/${id}`)
		            .then(() => {
		                loadMacchine();
		            })
		            .catch(error => {
		                console.error('Error deleting machine:', error);
		                alert('Errore nell\'eliminazione della macchina');
		            });
		    }
		}
        // Modifica Istituto
        function editIstituto(id) {
		    const nome = prompt('Nuovo nome istituto:');
		    const indirizzo = prompt('Nuovo indirizzo:');
		
		    if (nome && indirizzo) {
		        axios.put(`${API_BASE_URL}/admin/istituti/${id}`, { nome, indirizzo })
		            .then(() => {
		                loadIstituti();
		            })
		            .catch(error => {
		                console.error('Error updating istituto:', error);
		                alert('Errore nell\'aggiornamento dell\'istituto');
		            });
		    }
		}

        function deleteIstituto(id) {
            if (confirm('Sei sicuro di voler eliminare questo istituto?')) {
                axios.delete(`${API_BASE_URL}/admin/istituti/${id}`)
                    .then(() => {
                        loadIstituti();
                    })
                    .catch(error => {
                        console.error('Error deleting istituto:', error);
                        alert('Errore nell\'eliminazione dell\'istituto');
                    });
            }
        }

        // Gestione Macchine
        function configuraMacchina(id) {
            const statoId = prompt('Nuovo stato (1=Attiva, 2=Manutenzione, 3=Fuori servizio):');
            if (statoId) {
                axios.put(`${API_BASE_URL}/admin/macchine/${id}/stato`, { statoId: parseInt(statoId) })
                    .then(() => {
                    	loadMacchine();
                    	alert('Stato aggiornato correttamente!');
                    })
                    .catch(error => {
                        console.error('Error updating machine status:', error);
                        alert('Errore nell\'aggiornamento dello stato della macchina');
                    });
            }
        }

        // Add Bevanda
        function addBevanda() {
		    const nome = prompt('Nome bevanda:');
		    const prezzo = prompt('Prezzo:');
		
		    if (nome && prezzo) {
		        axios.post(`${API_BASE_URL}/admin/bevande`, { nome, prezzo })
		            .then(() => {
		                loadBevande();
		            })
		            .catch(error => {
		                console.error('Error adding beverage:', error);
		                alert('Errore nell\'aggiunta della bevanda');
		            });
		    }
		}
        
        // Aggiorna bevanda
        function updateBevanda(id) {
            const nome = prompt('Nuovo nome bevanda:');
            const prezzo = prompt('Nuovo prezzo:');

            if (nome && prezzo) {
                axios.put(`${API_BASE_URL}/admin/bevande/${id}`, { nome, prezzo })
                    .then(() => {
                        loadBevande();
                    })
                    .catch(error => {
                        console.error('Error updating beverage:', error);
                        alert('Errore nell\'aggiornamento della bevanda');
                    });
            }
        }
        // Elimina bevanda
        function deleteBevanda(id) {
            if (confirm('Sei sicuro di voler eliminare questa bevanda?')) {
                axios.delete(`${API_BASE_URL}/admin/bevande/${id}`)
                    .then(() => {
                        loadBevande();
                    })
                    .catch(error => {
                        console.error('Error deleting beverage:', error);
                        alert('Errore nell\'eliminazione della bevanda');
                    });
            }
        }

        // Gestione Manutenzioni
        function loadManutenzioni() {
            axios.get(`${API_BASE_URL}/manutenzioni`)
                .then(response => {
                    const manutenzioni = response.data;
                    // Implementare la visualizzazione delle manutenzioni
                })
                .catch(error => {
                    console.error('Error loading maintenance data:', error);
                    alert('Errore nel caricamento delle manutenzioni');
                });
        }

        function iniziaManutenzione(macchinaId) {
            axios.post(`${API_BASE_URL}/manutenzione`, { macchinaId })
                .then(() => {
                    loadManutenzioni();
                })
                .catch(error => {
                    console.error('Error starting maintenance:', error);
                    alert('Errore nell\'avvio della manutenzione');
                });
        }

        function completaManutenzione(id) {
            axios.put(`${API_BASE_URL}/manutenzione/${id}/completa`)
                .then(() => {
                    loadManutenzioni();
                })
                .catch(error => {
                    console.error('Error completing maintenance:', error);
                    alert('Errore nel completamento della manutenzione');
                });
        }

        function setFuoriServizio(macchinaId) {
            axios.put(`${API_BASE_URL}/manutenzione/${macchinaId}/fuori-servizio`)
                .then(() => {
                    loadMacchine();
                })
                .catch(error => {
                    console.error('Error setting machine out of service:', error);
                    alert('Errore nell\'impostazione fuori servizio');
                });
        }
        
        function loadMagazzino() {
            // Carica le bevande e le cialde disponibili
            axios.get(`${API_BASE_URL}/bevande`)
                .then(response => {
                    const bevande = response.data;
                    const scorteCialde = document.getElementById('scorteCialde');
                    scorteCialde.innerHTML = '';

                    bevande.forEach(bevanda => {
                        // Le cialde sono in un array all'interno della bevanda
                        const cialdeInfo = bevanda.cialde ? 
                            bevanda.cialde.map(c => `${c.nome}: ${c.quantitaDisponibile || 0}`).join(', ') : 
                            'Nessuna cialda';
                        
                        const div = document.createElement('div');
                        div.className = 'mb-2';
                        div.innerHTML = `
                            <span class="font-medium">${bevanda.nome}</span>: 
                            <span class="text-gray-600">${cialdeInfo}</span>
                        `;
                        scorteCialde.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Error loading bevande:', error);
                    alert('Errore nel caricamento delle scorte di cialde');
                });

            // Carica le macchine che necessitano di rifornimento
            axios.get(`${API_BASE_URL}/manutenzione`)
                .then(response => {
                    const manutenzioni = response.data;
                    const rifornimentiList = document.getElementById('rifornimentiList');
                    rifornimentiList.innerHTML = '';

                    // Filtra solo le manutenzioni di tipo RIFORNIMENTO_CIALDE
                    const rifornimenti = manutenzioni.filter(m => m.tipoIntervento === "RIFORNIMENTO_CIALDE");
                    
                    rifornimenti.forEach(rifornimento => {
                        const div = document.createElement('div');
                        div.className = 'mb-2';
                        div.innerHTML = `
                            <span class="font-medium">Macchina #${rifornimento.macchinaId}</span>: 
                            <span class="text-gray-600">${rifornimento.descrizione}</span>
                            <span class="text-sm text-blue-600">Urgenza: ${rifornimento.urgenza}</span>
                        `;
                        rifornimentiList.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Error loading rifornimenti:', error);
                    alert('Errore nel caricamento dei rifornimenti necessari');
                });
        }
        
        function loadFinanze() {
            // Carica i ricavi totali per il grafico
            axios.get(`/transazioni`)
                .then(response => {
                    const transazioni = response.data;
                    
                    // Raggruppa le transazioni per mese
                    const ricaviPerMese = {};
                    transazioni.forEach(t => {
                        // Estrai anno-mese dalla data (assumendo che dataOra sia nel formato ISO)
                        const data = new Date(t.dataOra);
                        const mese = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                        
                        if (!ricaviPerMese[mese]) {
                            ricaviPerMese[mese] = 0;
                        }
                        ricaviPerMese[mese] += t.importo;
                    });
                    
                    // Converti in array per il grafico
                    const labels = Object.keys(ricaviPerMese).sort();
                    const data = labels.map(mese => ricaviPerMese[mese]);
                    
                    const ricaviCtx = document.getElementById('ricaviChart').getContext('2d');
                    new Chart(ricaviCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Ricavi Mensili',
                                data: data,
                                borderColor: 'rgb(59, 130, 246)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading ricavi:', error);
                    alert('Errore nel caricamento dei ricavi');
                });

            // Carica le transazioni recenti
            axios.get(`/transazioni`)
                .then(response => {
                    // Prendiamo solo le ultime 10 transazioni
                    const transazioni = response.data.slice(0, 10);
                    const transazioniList = document.getElementById('transazioniList');
                    transazioniList.innerHTML = '';

                    transazioni.forEach(transazione => {
                        const div = document.createElement('div');
                        div.className = 'mb-2';
                        div.innerHTML = `
                            <span class="font-medium">${transazione.nomeBevanda || 'Bevanda #' + transazione.bevandaId}</span>: 
                            <span class="text-gray-600">€${transazione.importo.toFixed(2)} - ${new Date(transazione.dataOra).toLocaleString()}</span>
                            <span class="text-sm text-green-600">${transazione.nomeIstituto || ''}</span>
                        `;
                        transazioniList.appendChild(div);
                    });
                })
                .catch(error => {
                    console.error('Error loading transazioni:', error);
                    alert('Errore nel caricamento delle transazioni');
                });
        }
        
        function loadUtenti() {
            axios.get(`${API_BASE_URL}/admin/utenti`)
                .then(response => {
                    const utenti = response.data;
                    const tbody = document.getElementById('utentiList');
                    tbody.innerHTML = '';

                    utenti.forEach(utente => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        	
                            <td class="py-2">${utente.nome}</td>
                            <td class="py-2">${utente.ruolo}</td>
                            <td class="py-2">${utente.ultimoAccesso}</td>
                            <td class="py-2">
                                <button onclick="editUtente(${utente.id})" class="text-blue-500 hover:text-blue-700 mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteUtente(${utente.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading utenti:', error);
                    alert('Errore nel caricamento degli utenti');
                });
        }
        
        function addUser() {
            const nome = document.getElementById('nomeUtente').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const ruolo = document.getElementById('ruoloSelect').value;

            if (!nome || !username || !password || !ruolo) {
                alert('Compilare tutti i campi');
                return;
            }

            axios.post(`${API_BASE_URL}/admin/utenti`, { nome, username, password, ruolo })
                .then(() => {
                    hideModal('addUserModal');
                    loadUtenti();
                })
                .catch(error => {
                    console.error('Error adding user:', error);
                    alert('Errore nell\'aggiunta dell\'utente');
                });
        }
        
        function editUtente(id) {
            const nome = prompt('Nuovo nome utente:');
            const ruolo = prompt('Nuovo ruolo (Amministratore, Tecnico, Operatore):');

            if (nome && ruolo) {
                axios.put(`${API_BASE_URL}/admin/utenti/${id}`, { nome, ruolo })
                    .then(() => {
                        loadUtenti();
                    })
                    .catch(error => {
                        console.error('Error updating user:', error);
                        alert('Errore nell\'aggiornamento dell\'utente');
                    });
            }
        }
        
        function deleteUtente(id) {
            if (confirm('Sei sicuro di voler eliminare questo utente?')) {
                axios.delete(`${API_BASE_URL}/admin/utenti/${id}`)
                    .then(() => {
                        loadUtenti();
                    })
                    .catch(error => {
                        console.error('Error deleting user:', error);
                        alert('Errore nell\'eliminazione dell\'utente');
                    });
            }
        }
        
        function loadMonitoraggio() {
            // Carica le macchine e il loro stato
            axios.get(`${API_BASE_URL}/macchine`)
                .then(response => {
                    const macchine = response.data;
                    const statoSistemaDiv = document.getElementById('statoSistema');
                    
                    // Calcola lo stato generale del sistema
                    const totale = macchine.length;
                    const attive = macchine.filter(m => m.statoId === 1).length;
                    const percentualeAttive = (attive / totale * 100).toFixed(0);
                    
                    const statoDescrizione = percentualeAttive > 80 ? 
                        "Sistema funzionante correttamente" : 
                        percentualeAttive > 50 ? 
                            "Sistema parzialmente funzionante" : 
                            "Sistema compromesso";
                    
                    statoSistemaDiv.innerHTML = `
                        <div class="text-lg">${percentualeAttive}% delle macchine attive</div>
                        <div class="text-gray-600">${statoDescrizione}</div>
                    `;
                    
                    // Prepara i dati per il grafico delle performance
                    const inManutenzione = macchine.filter(m => m.statoId === 2).length;
                    const fuoriServizio = macchine.filter(m => m.statoId === 3).length;
                    
                    const perfCtx = document.getElementById('performanceChart').getContext('2d');
                    new Chart(perfCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Attive', 'In Manutenzione', 'Fuori Servizio'],
                            datasets: [{
                                data: [attive, inManutenzione, fuoriServizio],
                                backgroundColor: [
                                    'rgb(34, 197, 94)',
                                    'rgb(234, 179, 8)',
                                    'rgb(239, 68, 68)'
                                ]
                            }]
                        },
                        options: {
                            responsive: true
                        }
                    });
                })
                .catch(error => {
                    console.error('Error loading macchine:', error);
                    alert('Errore nel caricamento dello stato del sistema');
                });

            // Carica le manutenzioni attive (allarmi)
            axios.get(`${API_BASE_URL}/manutenzione`)
                .then(response => {
                    const manutenzioni = response.data.filter(m => m.stato !== "COMPLETATA");
                    const allarmiList = document.getElementById('allarmiList');
                    allarmiList.innerHTML = '';

                    if (manutenzioni.length === 0) {
                        const div = document.createElement('div');
                        div.className = 'text-green-600';
                        div.innerHTML = 'Nessun allarme attivo';
                        allarmiList.appendChild(div);
                    } else {
                        manutenzioni.forEach(manutenzione => {
                            const div = document.createElement('div');
                            div.className = 'mb-2 p-2 border-l-4 ' + 
                                (manutenzione.urgenza === 'ALTA' ? 'border-red-500 bg-red-50' : 
                                manutenzione.urgenza === 'MEDIA' ? 'border-yellow-500 bg-yellow-50' : 
                                'border-blue-500 bg-blue-50');
                            
                            div.innerHTML = `
                                <span class="font-medium">Macchina #${manutenzione.macchinaId}</span>: 
                                <span class="text-gray-600">${manutenzione.tipoIntervento}</span>
                                <div class="text-sm">${manutenzione.descrizione}</div>
                                <div class="text-xs text-gray-500">
                                    Richiesta: ${new Date(manutenzione.dataRichiesta).toLocaleString()}
                                </div>
                            `;
                            allarmiList.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading allarmi:', error);
                    alert('Errore nel caricamento degli allarmi');
                });
        }

        function getStatoClass(statoId) {
            switch(statoId) {
                case 1: return 'bg-green-100 text-green-800'; // Attiva
                case 2: return 'bg-yellow-100 text-yellow-800'; // In manutenzione
                case 3: return 'bg-red-100 text-red-800'; // Fuori servizio
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Initialize Charts
        function initCharts() {
            // Ricavi Chart
            const ricaviCtx = document.getElementById('ricaviChart').getContext('2d');
            new Chart(ricaviCtx, {
                type: 'line',
                data: {
                    labels: ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu'],
                    datasets: [{
                        label: 'Ricavi Mensili',
                        data: [12000, 19000, 15000, 17000, 22000, 20000],
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Attive', 'In Manutenzione', 'Fuori Servizio'],
                    datasets: [{
                        data: [75, 15, 10],
                        backgroundColor: [
                            'rgb(34, 197, 94)',
                            'rgb(234, 179, 8)',
                            'rgb(239, 68, 68)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            showTab('istituti');
            initCharts();
        });
    </script>
</body>
</html>