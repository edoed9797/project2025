<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributore Automatico - Selezione Bevande</title>
    
    <!-- Dipendenze esterne -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        .top-nav {
            background-color: #3B82F6;
            color: white;
            padding: 1rem 0;
        }
        
        .nav-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .brand-text {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-primary {
            background-color: #3B82F6;
            color: white;
        }
        
        .btn-secondary {
            background-color: #9CA3AF;
            color: white;
        }
        
        .btn-danger {
            background-color: #EF4444;
            color: white;
        }
        
        .hidden {
            display: none;
        }

        .status-indicator {
            padding: 0.5rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .p-8 {
        	padding: 14rem;
		}

        .status-active {
            background-color: #10B981;
            color: white;
        }

        .status-maintenance {
            background-color: #F59E0B;
            color: white;
        }

        .status-error {
            background-color: #EF4444;
            color: white;
        }

        .status-unknown {
            background-color: #6B7280;
            color: white;
        }

        .beverage-card {
            border: 2px solid #E5E7EB;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .beverage-card:hover:not(.unavailable) {
            border-color: #3B82F6;
            transform: scale(1.02);
        }

        .beverage-card.selected {
            border-color: #3B82F6;
            background-color: #EFF6FF;
        }

        .beverage-card.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .coin-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-color: #F3F4F6;
            transition: all 0.2s;
        }

        .coin-btn:hover:not(:disabled) {
            background-color: #E5E7EB;
            transform: scale(1.05);
        }

        .coin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sugar-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            background-color: #F3F4F6;
            transition: all 0.2s;
        }

        .sugar-btn.active {
            background-color: #3B82F6;
            color: white;
        }

        .alert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #FEF2F2;
            border: 1px solid #EF4444;
            color: #B91C1C;
            z-index: 50;
            display: none;
        }

        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #EFF6FF;
            border: 1px solid #3B82F6;
            color: #1E40AF;
            z-index: 50;
            display: none;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-content container mx-auto px-4">
            <div class="nav-brand">
                <span class="brand-text">Seleziona bevanda</span>
            </div>
            <div>
                <button onclick="window.location.href = '/spegni'" class="btn btn-danger">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>
            <div>
                <div class="user-menu">
                    <span id="userInfo" class="user-info hidden">
                        <span id="userName"></span>
                        <i class="fas fa-user"></i>
                    </span>
                    <a href="/index.html" class="btn btn-primary">
                        <i class="fas fa-home"></i> Home
                    </a>
                    <a class="btn btn-secondary" id="logoutBtn">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">Distributore Automatico <span id="machineNumber" class="text-blue-600"></span></h1>
                <div id="statusIndicator" class="status-indicator status-unknown">
                    <div class="w-3 h-3 rounded-full bg-current"></div>
                    <span class="status-text">Stato Sconosciuto</span>
                </div>
            </div>
        </header>

        <!-- Contenuto principale -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Sezione Bevande -->
            <div class="md:col-span-2">
                <div id="categoriesTabs" class="flex gap-4 mb-6">
                    <button class="tab-button px-4 py-2 rounded-lg bg-blue-600 text-white" data-category="all">Tutte</button>
                    <button class="tab-button px-4 py-2 rounded-lg bg-gray-200" data-category="coffee">Caffè</button>
                    <button class="tab-button px-4 py-2 rounded-lg bg-gray-200" data-category="hot">Bevande Calde</button>
                </div>

                <div id="beveragesList" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Le bevande verranno caricate dinamicamente -->
                </div>
            </div>

            <!-- Pannello di Controllo -->
            <div class="bg-white rounded-lg p-6 shadow-lg">
                <!-- Sezione Credito -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold mb-4">Credito Inserito</h2>
                    <div class="text-3xl font-bold text-blue-600 mb-4">
                        € <span id="currentCredit">0.00</span>
                    </div>

                    <!-- Monete -->
                    <div class="grid grid-cols-3 gap-4">
                        <button class="coin-btn" data-value="0.10">€0,10</button>
                        <button class="coin-btn" data-value="0.20">€0,20</button>
                        <button class="coin-btn" data-value="0.50">€0,50</button>
                        <button class="coin-btn" data-value="1.00">€1,00</button>
                        <button class="coin-btn" data-value="2.00">€2,00</button>
                    </div>
                </div>

                <!-- Opzioni Personalizzazione -->
                <div id="customizationOptions" class="mb-8 hidden">
                    <div id="sugarControl" class="flex flex-col gap-2">
                        <label class="text-sm text-gray-600">Zucchero</label>
                        <div class="flex gap-2">
                            <button class="sugar-btn" data-level="0">No</button>
                            <button class="sugar-btn" data-level="1">Poco</button>
                            <button class="sugar-btn active" data-level="2">Medio</button>
                            <button class="sugar-btn" data-level="3">Molto</button>
                        </div>
                    </div>
                </div>

                <!-- Pulsanti Azione -->
                <div class="flex gap-4">
                    <button id="dispenseButton" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" onclick="openErogationModal()" disabled>
						Eroga
					</button>
                    <button id="returnCreditButton" 
                            class="px-6 py-3 bg-gray-200 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        Resto
                    </button>
                </div>
            </div>
        </div>
    </div>
	<!-- Modale per l'erogazione -->
	<div id="erogationModal" class="overlay hidden">
		<div class="bg-white p-8 rounded-lg text-center w-full max-w-2xl">
			<!-- Contenuto del modale -->
			<div id="modalContent">
				<!-- Qui verrà caricata la pagina HTML generata -->
				
			</div>
			<h4>Attendi..</h4>
		</div>
	</div>
    <!-- Overlay Erogazione
    <div id="dispensingOverlay" class="overlay hidden">
        <div class="bg-white p-8 rounded-lg text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mb-4 mx-auto"></div>
            <h3 class="text-xl font-bold mb-4">Erogazione in Corso</h3>
            <p id="dispensingStatus" class="text-gray-600">Preparazione bevanda...</p>
        </div>
    </div> -->

    <!-- Alert -->
    <div id="alertBox" class="alert">
        <p id="alertMessage"></p>
    </div>

    <!-- Notification -->
    <div id="notificationBox" class="notification">
        <p id="notificationMessage"></p>
    </div>

    <script>
        // Configurazione
        const API_BASE_URL = 'https://localhost:8443/api';
        const MQTT_CONFIG = {
            host: 'localhost',
            port: 9002,  // Porta WebSocket
            useSSL: true,
            username: '20019309',
            password: 'Pissir2024!',
            keepAliveInterval: 30,
            cleanSession: true,
        };

        // Stato dell'applicazione - verrà inizializzato dai dati della macchina
        let machineState = {
            id: null,
            cassaAttuale: 0,
            cassaMassima: 0,
            stato: 1,
            creditoAttuale: 0,
            bevande: [],
            cialde: []
        };

        let currentMachineId = null;
        let client = null;
        let currentCredit = 0;
        let selectedBeverage = null;
        let sugarLevel = 2;
        let isInitialStateReceived = false;
        let isPollingActive = false;

        // Riferimenti DOM
        const elements = {
            machineNumber: document.getElementById('machineNumber'),
            statusIndicator: document.getElementById('statusIndicator'),
            currentCredit: document.getElementById('currentCredit'),
            beveragesList: document.getElementById('beveragesList'),
            dispenseButton: document.getElementById('dispenseButton'),
            returnCreditButton: document.getElementById('returnCreditButton'),
            dispensingOverlay: document.getElementById('dispensingOverlay'),
            dispensingStatus: document.getElementById('dispensingStatus'),
            alertBox: document.getElementById('alertBox'),
            alertMessage: document.getElementById('alertMessage'),
            notificationBox: document.getElementById('notificationBox'),
            notificationMessage: document.getElementById('notificationMessage'),
            logoutBtn: document.getElementById('logoutBtn'),
            userInfo: document.getElementById('userInfo'),
            userName: document.getElementById('userName')
        };

        // Topic MQTT - verranno aggiornati con l'ID corretto
        const MQTT_TOPICS = {
            // Topic di sottoscrizione per lo stato della macchina
            MACHINE_STATUS: 'macchine/${machineId}/stato',
            MACHINE_STATUS_REQUEST: 'macchine/${machineId}/stato',
            
            // Topic per la gestione della cassa
            CASH_INSERT: 'macchine/${machineId}/cassa/inserimentoCredito', 
            CASH_RETURN: 'macchine/${machineId}/cassa/richiestaResto',
            CASH_STATUS: 'macchine/${machineId}/cassa/stato',
            
            // Topic per le bevande
            BEVERAGE_REQUEST: 'macchine/${machineId}/cassa/richiestaBevanda',
            BEVERAGE_STATUS: 'macchine/${machineId}/bevande/stato',
            
            // Altri topic
            MAINTENANCE: 'macchine/${machineId}/manutenzione/stato',
            ALERTS: 'macchine/${machineId}/eventi'
        };
        
        let lastStateRequestTime = 0;
        const STATE_REQUEST_DEBOUNCE = 3000;
        
        let lastCashAlertTime = 0;
        const CASH_ALERT_COOLDOWN = 60000;
        
        // Funzioni di utility per l'autenticazione
        const AuthUtils = {
            async ensureAuthToken() {
                let token = localStorage.getItem('jwt_token');
                if (!token) {
                    token = await this.generateAnonymousToken();
                    localStorage.setItem('jwt_token', token);
                    localStorage.setItem('userRole', 'anonymous');
                }
                return token;
            },

            async generateAnonymousToken() {
                try {
                    const response = await axios.post(`${API_BASE_URL}/auth/anonymous`);
                    return response.data.token;
                } catch (error) {
                    console.error('Errore nella generazione del token anonimo:', error);
                    return null;
                }
            },

            getAuthHeaders() {
                const token = localStorage.getItem('jwt_token');
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            },
            
            logout() {
                localStorage.removeItem('jwt_token');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userName');
                window.location.href = '/index.html';
            },
            
            updateUIForAuthState() {
                const token = localStorage.getItem('jwt_token');
                const userName = localStorage.getItem('userName');
                
                if (token && userName && userName !== 'anonymous') {
                    elements.userInfo.classList.remove('hidden');
                    elements.userName.textContent = userName;
                    elements.logoutBtn.classList.remove('hidden');
                } else {
                    elements.userInfo.classList.add('hidden');
                    elements.logoutBtn.classList.add('hidden');
                }
            }
        };

        // Funzione per ottenere l'ID della macchina dalla URL
        function getMachineIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('machine');
            if (!id) {
                showAlert('ID macchina non specificato');
                return null;
            }
            return parseInt(id);
        }

        // Funzione per inizializzare lo stato della macchina
        async function initializeMachineState() {
            try {
                // Ottiene l'ID dalla URL
                currentMachineId = getMachineIdFromUrl();
                if (!currentMachineId) {
                    throw new Error('ID macchina non valido');
                }
                
                await AuthUtils.ensureAuthToken();
                AuthUtils.updateUIForAuthState();
                
                // Aggiorna l'ID nei topic MQTT
                Object.keys(MQTT_TOPICS).forEach(key => {
                    MQTT_TOPICS[key] = MQTT_TOPICS[key].replace('${machineId}', currentMachineId);
                });

                // Recupera i dati della macchina
                const response = await axios.get(
                    `${API_BASE_URL}/macchine/${currentMachineId}`,
                    { headers: AuthUtils.getAuthHeaders() }
                );
                const machineData = response.data;

                // Inizializza lo stato della macchina
                machineState = {
                    id: machineData.id,
                    cassaAttuale: machineData.cassaAttuale,
                    cassaMassima: machineData.cassaMassima,
                    stato: machineData.statoId,
                    creditoAttuale: machineData.creditoAttuale || 0,
                    bevande: machineData.bevande || [],
                    cialde: machineData.cialde || []
                };

                // Aggiorna l'interfaccia
                elements.machineNumber.textContent = `#${machineState.id}`;
                updateMachineStatus(machineState.stato);
                
                // Carica le bevande disponibili
                await loadBeverages();

                // Inizia la connessione MQTT
                await initializeMQTT();
                
            } catch (error) {
                console.error('Errore nell\'inizializzazione della macchina:', error);
                showAlert('Errore nel caricamento dei dati della macchina');
            }
        }

        // Inizializzazione MQTT
        async function initializeMQTT() {
            return new Promise((resolve, reject) => {
                const clientId = 'web_client_' + Math.random().toString(16).substr(2, 8);
                
                // Costruzione corretta dell'URL WebSocket
                const wsUrl = MQTT_CONFIG.useSSL ? 
                    `wss://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}/` : 
                    `ws://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}/`;
            
                try {
                    // Crea il client MQTT
                    client = new Paho.MQTT.Client(wsUrl, clientId);
            
                    // Configura i callback
                    client.onConnectionLost = onConnectionLost;
                    client.onMessageArrived = onMessageArrived;
            
                    // Configura le opzioni di connessione
                    const connectOptions = {
                        userName: MQTT_CONFIG.username,
                        password: MQTT_CONFIG.password,
                        keepAliveInterval: MQTT_CONFIG.keepAliveInterval,
                        cleanSession: MQTT_CONFIG.cleanSession,
                        onSuccess: () => {
                            onConnect();
                            resolve();
                        },
                        onFailure: (error) => {
                            onConnectFailure(error);
                            reject(error);
                        },
                        timeout: 3
                    };
            
                    // Debug logging
                    console.log('Tentativo di connessione MQTT:', {
                        url: wsUrl,
                        clientId: clientId,
                        useSSL: MQTT_CONFIG.useSSL,
                        port: MQTT_CONFIG.port
                    });
            
                    // Connetti il client
                    client.connect(connectOptions);
            
                } catch (error) {
                    console.error('Errore nella creazione del client MQTT:', error);
                    reject(error);
                    // Riprova la connessione dopo un ritardo
                    setTimeout(() => {
                        console.log('Ritento connessione MQTT...');
                        initializeMQTT().then(resolve).catch(reject);
                    }, 3000);
                }
            });
        }

        function onConnect() {
            showNotification('Connesso al sistema');
            Object.values(MQTT_TOPICS).forEach(topic => {
                client.subscribe(topic);
            });
            
            // Richiedi lo stato iniziale della macchina all'avvio
            requestInitialState();
        }
        
        function requestInitialState() {
            // Esegue una singola richiesta iniziale dello stato della macchina
            console.log("Richiesta stato iniziale della macchina");
            publishMessage(MQTT_TOPICS.MACHINE_STATUS_REQUEST, { timestamp: Date.now() });
            
        }

        function onConnectFailure(error) {
            console.error('Errore di connessione MQTT:', error);
            showAlert(`Errore di connessione: ${error.errorMessage}`);
            
            // Implementa backoff esponenziale per i tentativi
            let retryCount = 0;
            const maxRetries = 5;

            function retryConnection() {
                if (retryCount >= maxRetries) {
                    showAlert('Impossibile stabilire la connessione. Ricaricare la pagina.');
                    return;
                }

                const delay = Math.min(1000 * Math.pow(2, retryCount), 10000);
                console.log(`Tentativo di riconnessione ${retryCount + 1}/${maxRetries} tra ${delay}ms`);

                setTimeout(() => {
                    retryCount++;
                    initializeMQTT();
                }, delay);
            }

            retryConnection();
        }
        
        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log('Connessione MQTT persa:', responseObject.errorMessage);
                showAlert('Connessione al server persa. Tentativo di riconnessione...');
                handleReconnect();
            }
        }

        function onMessageArrived(message) {
        	console.log(`[${new Date().toISOString()}] MQTT Messaggio ricevuto: ${message.destinationName}`, message.payloadString);
        	try {
                const topic = message.destinationName;
                let payload;
                
                try {
                    payload = JSON.parse(message.payloadString);
                } catch (parseError) {
                    payload = message.payloadString;
                }
                
                const isRequestMessage = payload && 
                typeof payload === 'object' && 
                (payload.request || payload.purpose);
                
                switch (topic) {
                    case MQTT_TOPICS.MACHINE_STATUS:
                        if (!isRequestMessage) {
                            console.log("Ricevuto stato macchina:", payload);
                            handleMachineStatus(payload);
                        }
                        break;
                    case MQTT_TOPICS.CASH_STATUS:
                        if (!payload.request) {
                            console.log("Ricevuto stato cassa:", payload);
                            handleCashStatus(payload);
                        }
                        break;
                    case MQTT_TOPICS.BEVERAGE_STATUS:
                        console.log("Ricevuto stato bevanda:", payload);
                        handleBeverageStatus(payload);
                        break;
                    case MQTT_TOPICS.ALERTS:
                        console.log("Ricevuto alert:", payload);
                        handleAlerts(payload);
                        break;
                    default:
                        // Non loggare messaggi non gestiti per topic sconosciuti
                        break;
                }
            } catch (error) {
                console.error('Errore nel processamento del messaggio:', error);
            }
        }
        
        function handleReconnect() {
            console.log('Tentativo di riconnessione MQTT...');
            setTimeout(() => {
                try {
                    initializeMQTT();
                } catch (error) {
                    console.error('Errore durante la riconnessione:', error);
                    handleReconnect();
                }
            }, 3000);
        }

        // Gestori dei messaggi MQTT
        function handleMachineStatus(status) {
            // Aggiorna lo stato della macchina solo se abbiamo dati validi
            if (status && typeof status === 'object' && !status.request) {
                machineState = { ...machineState, ...status };
                
                // Aggiorna l'interfaccia
                updateMachineStatus(machineState.stato);
                updateUIBasedOnMachineState();
                
                // Se non abbiamo ancora ricevuto lo stato della cassa, chiediamolo
                if (currentCredit === 0 && machineState.creditoAttuale > 0) {
                    currentCredit = machineState.creditoAttuale;
                    updateCreditDisplay();
                    updateDispenseButtonState();
                    elements.returnCreditButton.disabled = currentCredit <= 0;
                }
                
                if (status.cassaAttuale / status.cassaMassima > 0.9) {
                    const now = Date.now();
                    if (now - lastCashAlertTime > CASH_ALERT_COOLDOWN) {
                        lastCashAlertTime = now;
                        publishMessage(MQTT_TOPICS.ALERTS, {
                            tipo: 'CASSA_PIENA',
                            messaggio: 'Necessario svuotamento cassa',
                            livello: 2
                        });
                    }
                }
            }
        }
        
        function handleCashStatus(status) {
            // Ignora le richieste di status
            if (status && typeof status === 'object' && status.request) {
                return;
            }
            
            // Verifica se status è una stringa (potrebbe essere un valore numerico diretto)
            if (typeof status === 'string' && !isNaN(parseFloat(status))) {
                currentCredit = parseFloat(status);
            } 
            // Verifica se è un oggetto con la proprietà creditoAttuale
            else if (status && typeof status === 'object' && 'creditoAttuale' in status) {
                currentCredit = status.creditoAttuale;
            }
            
            // Assicura che currentCredit sia un numero
            if (currentCredit === undefined || isNaN(currentCredit)) {
                currentCredit = 0;
                console.warn("Credito non valido, impostato a 0");
            }
            
            updateCreditDisplay();
            updateDispenseButtonState();
            elements.returnCreditButton.disabled = currentCredit <= 0;
        }

        function handleBeverageStatus(status) {
			if (status.completed) {
				closeErogationModal();
				showNotification('Bevanda erogata con successo!');
				
				// Richiedi aggiornamento dello stato solo una volta dopo l'erogazione completata
				console.log("Richiesta aggiornamento stato dopo erogazione completata");
				publishMessage(MQTT_TOPICS.MACHINE_STATUS, { 
					request: 'getStatus', 
					timestamp: Date.now(),
					purpose: 'post-dispense-update' 
				});
				
				// Aggiorna anche lo stato della cassa
				publishMessage(MQTT_TOPICS.CASH_STATUS, { 
					request: 'getStatus', 
					timestamp: Date.now(),
					purpose: 'post-dispense-update' 
				});
			} else if (status.error) {
				closeErogationModal();
				showAlert(`Errore: ${status.error}`);
				
				// Richiedi aggiornamento solo una volta anche in caso di errore
				console.log("Richiesta aggiornamento stato dopo errore erogazione");
				publishMessage(MQTT_TOPICS.MACHINE_STATUS, { 
					request: 'getStatus', 
					timestamp: Date.now(),
					purpose: 'post-error-update' 
				});
				
				// Aggiorna anche lo stato della cassa
				publishMessage(MQTT_TOPICS.CASH_STATUS, { 
					request: 'getStatus', 
					timestamp: Date.now(),
					purpose: 'post-error-update' 
				});
			}
		}

        function handleAlerts(alert) {
            switch(alert.tipo) {
                case 'CASSA_PIENA':
                    showAlert('La cassa è quasi piena. Verrà chiamato un tecnico per lo svuotamento.');
                    break;
                case 'MANUTENZIONE_NECESSARIA':
                    showAlert('È necessaria una manutenzione. Un tecnico verrà inviato presto.');
                    break;
                case 'CIALDE_ESAURITE':
                    showAlert(`Cialde esaurite: ${alert.messaggio}`);
                    break;
            }
        }

        // Funzioni UI
        function updateMachineStatus(statusId) {
            const statusMap = {
                1: { text: 'Attiva', class: 'status-active' },
                2: { text: 'Manutenzione', class: 'status-maintenance' },
                3: { text: 'Fuori Servizio', class: 'status-error' }
            };

            const status = statusMap[statusId] || { text: 'Sconosciuto', class: 'status-unknown' };
            elements.statusIndicator.className = `status-indicator ${status.class}`;
            elements.statusIndicator.querySelector('.status-text').textContent = status.text;
        }

        function updateUIBasedOnMachineState() {
            const isActive = machineState.stato === 1;
            document.querySelectorAll('.coin-btn').forEach(btn => {
                btn.disabled = !isActive;
            });
            elements.dispenseButton.disabled = !isActive || !selectedBeverage || currentCredit < (selectedBeverage?.price || 0);
            elements.returnCreditButton.disabled = !isActive || currentCredit <= 0;
        }

        function updateCreditDisplay() {
            // Assicurati che currentCredit sia un numero
            let creditToDisplay = 0;
            
            if (typeof currentCredit === 'number' && !isNaN(currentCredit)) {
                creditToDisplay = currentCredit;
            } else {
                console.warn("Valore di credito non valido:", currentCredit);
            }
            
            elements.currentCredit.textContent = creditToDisplay.toFixed(2);
        }

        function updateDispenseButtonState() {
            elements.dispenseButton.disabled = !selectedBeverage || 
                                            currentCredit < (selectedBeverage?.price || 0) || 
                                            machineState.stato !== 1;
        }

        function showAlert(message) {
            elements.alertMessage.textContent = message;
            elements.alertBox.style.display = 'block';
            setTimeout(() => {
                elements.alertBox.style.display = 'none';
            }, 5000);
        }

        function showNotification(message) {
            elements.notificationMessage.textContent = message;
            elements.notificationBox.style.display = 'block';
            setTimeout(() => {
                elements.notificationBox.style.display = 'none';
            }, 3000);
        }

        function handleCoinInsertion(value) {
            if (machineState.cassaAttuale + currentCredit + value > machineState.cassaMassima) {
                showAlert('Impossibile accettare monete. Cassa quasi piena.');
                return;
            }

            console.log("Inserimento moneta:", value);
            
            // Aggiorna il credito lato client per feedback immediato
            currentCredit += value;
            updateCreditDisplay();
            updateDispenseButtonState();
            elements.returnCreditButton.disabled = currentCredit <= 0;
            
            // Pubblica il messaggio MQTT - Converti esplicitamente il valore in stringa
            const valueStr = value.toString();
            const mqttMessage = new Paho.MQTT.Message(valueStr);
            mqttMessage.destinationName = MQTT_TOPICS.CASH_INSERT;
            client.send(mqttMessage);
        }

        function handleCreditReturn() {
            if (currentCredit <= 0) return;
            
            const creditToReturn = currentCredit;
            publishMessage(MQTT_TOPICS.CASH_RETURN, currentCredit);
            
            // Mostra subito un messaggio con il credito restituito
            showNotification(`Restituiti € ${creditToReturn.toFixed(2)}`);
            
            // Aggiorna immediatamente l'UI
            currentCredit = 0;
            updateCreditDisplay();
            updateDispenseButtonState();
            elements.returnCreditButton.disabled = true;
            
            // Richiedi aggiornamento dello stato della macchina dopo la restituzione
            setTimeout(() => {
                requestInitialState();
            }, 500);
        }

        
        // Funzione per verificare lo stato della macchina prima dell'erogazione
        async function checkMachineStatusBeforeDispense() {
            return new Promise((resolve, reject) => {
                console.log("Verifica stato macchina prima dell'erogazione");
                
                // Richiedi lo stato attuale della macchina una sola volta
                publishMessage(MQTT_TOPICS.MACHINE_STATUS, { 
                    request: 'getStatus', 
                    timestamp: Date.now(),
                    purpose: 'pre-dispense-check'
                });
                
                // Aspetta una risposta per massimo 3 secondi
                const timeout = setTimeout(() => {
                    console.warn("Timeout nella verifica dello stato della macchina");
                    reject(new Error("Timeout verifica stato macchina"));
                }, 3000);
                
                // Funzione temporanea per gestire la risposta
                const tempHandler = function(message) {
                    try {
                        if (message.destinationName === MQTT_TOPICS.MACHINE_STATUS) {
                            let payload;
                            try {
                                payload = JSON.parse(message.payloadString);
                            } catch {
                                payload = message.payloadString;
                            }
                            
                            // Ignora i messaggi di richiesta
                            if (payload.request) return;
                            
                            console.log("Ricevuta risposta stato macchina pre-erogazione:", payload);
                            
                            // Aggiorna lo stato della macchina
                            if (payload && typeof payload === 'object') {
                                machineState = { ...machineState, ...payload };
                                
                                // Verifica se la macchina è attiva
                                if (machineState.stato !== 1) {
                                    clearTimeout(timeout);
                                    client.onMessageArrived = onMessageArrived; // Ripristina il gestore originale
                                    reject(new Error("La macchina non è attiva"));
                                    return;
                                }
                                
                                // Verifica credito
                                if (currentCredit < selectedBeverage.price) {
                                    clearTimeout(timeout);
                                    client.onMessageArrived = onMessageArrived;
                                    reject(new Error("Credito insufficiente"));
                                    return;
                                }
                                
                                // Tutto ok, procedi
                                clearTimeout(timeout);
                                client.onMessageArrived = onMessageArrived;
                                resolve();
                            }
                        }
                    } catch (error) {
                        console.error('Errore nella verifica dello stato:', error);
                        clearTimeout(timeout);
                        client.onMessageArrived = onMessageArrived;
                        reject(error);
                    }
                };
                
                // Salva il gestore originale e sostituiscilo temporaneamente
                const originalHandler = client.onMessageArrived;
                client.onMessageArrived = tempHandler;
                
                // Dopo il timeout, ripristina il gestore originale
                setTimeout(() => {
                    if (client.onMessageArrived === tempHandler) {
                        console.log("Ripristino handler originale dopo timeout");
                        client.onMessageArrived = onMessageArrived;
                    }
                }, 3100);
            });
        }

        // Funzioni di gestione delle bevande
        function selectBeverage(beverageId, price, isAvailable) {
            if (!isAvailable) return;
            
            selectedBeverage = { id: beverageId, price };
            document.querySelectorAll('.beverage-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.beverage-card[data-id="${beverageId}"]`).classList.add('selected');
            document.getElementById('customizationOptions').classList.remove('hidden');
            updateDispenseButtonState();
        }

        async function loadBeverages() {
            try {
                const response = await axios.get(
                    `${API_BASE_URL}/macchine/${currentMachineId}/bevande`,
                    { headers: AuthUtils.getAuthHeaders() }
                );
                machineState.bevande = response.data;
                renderBeverages(machineState.bevande);
            } catch (error) {
                console.error('Errore nel caricamento delle bevande:', error);
                showAlert('Errore nel caricamento delle bevande disponibili');
            }
        }

        function renderBeverages(beverages) {
            elements.beveragesList.innerHTML = beverages.map(beverage => `
                <div class="beverage-card ${beverage.disponibile ? '' : 'unavailable'}" 
                     data-id="${beverage.id}" 
                     data-price="${beverage.prezzo}"
                     onclick="selectBeverage(${beverage.id}, ${beverage.prezzo}, ${beverage.disponibile})">
                    <h3 class="font-bold">${beverage.nome}</h3>
                    <p class="text-gray-600">€${beverage.prezzo.toFixed(2)}</p>
                    ${beverage.disponibile ? '' : '<p class="text-red-600">Non disponibile</p>'}
                </div>
            `).join('');
        }
        
        function resetSelection() {
            selectedBeverage = null;
            document.querySelectorAll('.beverage-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('customizationOptions').classList.add('hidden');
            updateDispenseButtonState();
        }

        
        function publishMessage(topic, message) {
            if (!client?.isConnected()) {
                showAlert('Non connesso al sistema');
                return;
            }
            
            if (topic === MQTT_TOPICS.MACHINE_STATUS && message && message.request === 'getStatus') {
                    const now = Date.now();
                    if (now - lastStateRequestTime < STATE_REQUEST_DEBOUNCE) {
                        console.log("Richiesta stato ignorata (debounce)");
                        return;
                    }
                    lastStateRequestTime = now;
            }
            
            // Converti il messaggio in stringa JSON
            let messageStr;
            if (typeof message === 'object') {
                messageStr = JSON.stringify(message);
            } else {
                messageStr = String(message); // Converti numeri o altri tipi in stringhe
            }
            
            const payload = new Paho.MQTT.Message(messageStr);
            payload.destinationName = topic;
            payload.qos = 1;
            payload.retained = false;

            client.send(payload);
            console.log(`Pubblicato: Topic: ${topic} - Messaggio: ${messageStr}`);
        }

        // Funzione per azzerare il credito prima di lasciare la pagina
        function resetCreditBeforeLeaving() {
            if (currentCredit > 0) {
                console.log("Richiesta restituzione credito prima di lasciare la pagina: €", currentCredit);
                publishMessage(MQTT_TOPICS.CASH_RETURN, currentCredit);
                currentCredit = 0;
            }
        }
		
        function openErogationModal() {
            const modal = document.getElementById('erogationModal');
            const modalContent = document.getElementById('modalContent');

            // Carica la pagina HTML generata nel modale
            modalContent.innerHTML = `
                <style>
            
            		
                    #erogationModal .loader {
                    }

                    #erogationModal .container {
                        width: 300px;
                        height: 280px;
                        position: absolute;
                        top: calc(50% - 140px);
                        left: calc(50% - 150px);
                    }

                    #erogationModal .coffee-header {
                        width: 100%;
                        height: 80px;
                        position: absolute;
                        top: 0;
                        left: 0;
                        background-color: #ddcfcc;
                        border-radius: 10px;
                    }

                    #erogationModal .coffee-header__buttons {
                        width: 25px;
                        height: 25px;
                        position: absolute;
                        top: 25px;
                        background-color: #282323;
                        border-radius: 50%;
                    }

                    #erogationModal .coffee-header__buttons::after {
                        content: "";
                        width: 8px;
                        height: 8px;
                        position: absolute;
                        bottom: -8px;
                        left: calc(50% - 4px);
                        background-color: #615e5e;
                    }

                    #erogationModal .coffee-header__button-one {
                        left: 15px;
                    }

                    #erogationModal .coffee-header__button-two {
                        left: 50px;
                    }

                    #erogationModal .coffee-header__display {
                        width: 50px;
                        height: 50px;
                        position: absolute;
                        top: calc(50% - 25px);
                        left: calc(50% - 25px);
                        border-radius: 50%;
                        background-color: #000000;
                        border: 5px solid #ff0000;
                        box-sizing: border-box;
                    }

                    #erogationModal .coffee-header__details {
                        width: 8px;
                        height: 20px;
                        position: absolute;
                        top: 10px;
                        right: 10px;
                        background-color: #9b9091;
                        box-shadow: -12px 0 0 #9b9091, -24px 0 0 #9b9091;
                    }

                    #erogationModal .coffee-medium {
                        width: 90%;
                        height: 160px;
                        position: absolute;
                        top: 80px;
                        left: calc(50% - 45%);
                        background-color: #bcb0af;
                    }

                    #erogationModal .coffee-medium:before {
                        content: "";
                        width: 90%;
                        height: 100px;
                        background-color: #776f6e;
                        position: absolute;
                        bottom: 0;
                        left: calc(50% - 45%);
                        border-radius: 20px 20px 0 0;
                    }

                    #erogationModal .coffe-medium__exit {
                        width: 60px;
                        height: 20px;
                        position: absolute;
                        top: 0;
                        left: calc(50% - 30px);
                        background-color: #231f20;
                    }

                    #erogationModal .coffe-medium__exit::before {
                        content: "";
                        width: 50px;
                        height: 20px;
                        border-radius: 0 0 50% 50%;
                        position: absolute;
                        bottom: -20px;
                        left: calc(50% - 25px);
                        background-color: #231f20;
                    }

                    #erogationModal .coffe-medium__exit::after {
                        content: "";
                        width: 10px;
                        height: 10px;
                        position: absolute;
                        bottom: -30px;
                        left: calc(50% - 5px);
                        background-color: #231f20;
                    }

                    #erogationModal .coffee-medium__arm::before {
                        content: "";
                        width: 15px;
                        height: 5px;
                        position: absolute;
                        top: 7px;
                        left: -15px;
                        background-color: #9e9495;
                    }

                    #erogationModal .coffee-medium__cup {
                        width: 80px;
                        height: 47px;
                        position: absolute;
                        bottom: 0;
                        left: calc(50% - 40px);
                        background-color: #FFF;
                        border-radius: 0 0 70px 70px / 0 0 110px 110px;
                    }

                    #erogationModal .coffee-medium__cup::after {
                        content: "";
                        width: 20px;
                        height: 20px;
                        position: absolute;
                        top: 6px;
                        right: -13px;
                        border: 5px solid #FFF;
                        border-radius: 50%;
                    }

                    @keyframes liquid {
                        0% {
                            height: 0px;
                            opacity: 1;
                        }

                        5% {
                            height: 0px;
                            opacity: 1;
                        }

                        20% {
                            height: 62px;
                            opacity: 1;
                        }

                        95% {
                            height: 62px;
                            opacity: 1;
                        }

                        100% {
                            height: 62px;
                            opacity: 0;
                        }
                    }

                    #erogationModal .coffee-medium__liquid {
                        width: 6px;
                        height: 63px;
                        opacity: 0;
                        position: absolute;
                        top: 50px;
                        left: calc(50% - 3px);
                        background-color: #74372b;
                        animation: liquid 4s 4s linear infinite;
                    }

                    #erogationModal .coffee-medium__smoke {
                        width: 8px;
                        height: 20px;
                        position: absolute;
                        border-radius: 5px;
                        background-color: #b3aeae;
                    }

                    @keyframes smokeOne {
                        0% {
                            bottom: 20px;
                            opacity: 0;
                        }

                        40% {
                            bottom: 50px;
                            opacity: .5;
                        }

                        80% {
                            bottom: 80px;
                            opacity: .3;
                        }

                        100% {
                            bottom: 80px;
                            opacity: 0;
                        }
                    }

                    @keyframes smokeTwo {
                        0% {
                            bottom: 40px;
                            opacity: 0;
                        }

                        40% {
                            bottom: 70px;
                            opacity: .5;
                        }

                        80% {
                            bottom: 80px;
                            opacity: .3;
                        }

                        100% {
                            bottom: 80px;
                            opacity: 0;
                        }
                    }

                    #erogationModal .coffee-medium__smoke-one {
                        opacity: 0;
                        bottom: 50px;
                        left: 102px;
                        animation: smokeOne 3s 4s linear infinite;
                    }

                    #erogationModal .coffee-medium__smoke-two {
                        opacity: 0;
                        bottom: 70px;
                        left: 118px;
                        animation: smokeTwo 3s 5s linear infinite;
                    }

                    #erogationModal .coffee-medium__smoke-three {
                        opacity: 0;
                        bottom: 65px;
                        right: 118px;
                        animation: smokeTwo 3s 6s linear infinite;
                    }

                    #erogationModal .coffee-medium__smoke-for {
                        opacity: 0;
                        bottom: 50px;
                        right: 102px;
                        animation: smokeOne 3s 5s linear infinite;
                    }

                    #erogationModal .coffee-footer {
                        width: 95%;
                        height: 15px;
                        position: absolute;
                        bottom: 25px;
                        left: calc(50% - 47.5%);
                        background-color: #4d4d4d;
                        border-radius: 10px;
                    }

                    #erogationModal .coffee-footer::after {
                        content: "";
                        width: 106%;
                        height: 26px;
                        position: absolute;
                        bottom: -25px;
                        left: -8px;
                        background-color: #000;
                    }

                    #erogationModal .screen {
                        width: 100%;
                        height: 60px;
                        position: absolute;
                        top: -70px;
                        left: 0;
                        background-color: #333;
                        border-radius: 10px;
                        padding: 10px;
                        box-sizing: border-box;
                        color: #fff;
                        font-family: Arial, sans-serif;
                        text-align: center;
                    }

                    #erogationModal .screen-text {
                        font-size: 14px;
                        margin-bottom: 10px;
                    }

                    #erogationModal .progress-bar {
                        width: 100%;
                        height: 10px;
                        background-color: #555;
                        border-radius: 5px;
                        overflow: hidden;
                    }

                    #erogationModal .progress {
                        width: 0%;
                        height: 100%;
                        background-color: #4caf50;
                        border-radius: 5px;
                        animation: progress 10s linear forwards;
                    }

                    @keyframes progress {
                        0% {
                            width: 0%;
                        }
                        100% {
                            width: 100%;
                        }
                    }
                </style>
                <div class="loader">
                    <div class="container">
                        <div class="screen">
                            <div class="screen-text">Erogazione bevanda in corso...</div>
                            <div class="progress-bar">
                                <div class="progress"></div>
                            </div>
                        </div>
                        <div class="coffee-header">
                            <div class="coffee-header__buttons coffee-header__button-one"></div>
                            <div class="coffee-header__buttons coffee-header__button-two"></div>
                            <div class="coffee-header__display"></div>
                            <div class="coffee-header__details"></div>
                        </div>
                        <div class="coffee-medium">
                            <div class="coffe-medium__exit"></div>
                            <div class="coffee-medium__liquid"></div>
                            <div class="coffee-medium__smoke coffee-medium__smoke-one"></div>
                            <div class="coffee-medium__smoke coffee-medium__smoke-two"></div>
                            <div class="coffee-medium__smoke coffee-medium__smoke-three"></div>
                            <div class="coffee-medium__smoke coffee-medium__smoke-for"></div>
                            <div class="coffee-medium__cup"></div>
                        </div>
                        <div class="coffee-footer"></div>
                    </div>
                </div>
            `;

            // Mostra il modale
            modal.classList.remove('hidden');

            // Avvia l'animazione della progress bar
            startProgressBar();
        }

		// Funzione per chiudere il modale
		function closeErogationModal() {
			const modal = document.getElementById('erogationModal');
			modal.classList.add('hidden');
		}

		// Funzione per avviare la progress bar
		function startProgressBar() {
			const progressBar = document.querySelector('.progress');
			progressBar.style.animation = 'progress 10s linear forwards';

			// Chiudi il modale e mostra il messaggio di conferma al completamento
			setTimeout(() => {
				closeErogationModal();
				showNotification('Bevanda erogata con successo!');
			}, 7000); 
		}
		
		async function handleBeverageRequest() {
			if (!selectedBeverage || currentCredit < selectedBeverage.price) return;
			
			try {
				// Verifica lo stato della macchina prima di procedere con l'erogazione
				await checkMachineStatusBeforeDispense();
				
				// Apri il modale di erogazione
				openErogationModal();
				
				// Pubblica il messaggio MQTT per richiedere l'erogazione
				publishMessage(MQTT_TOPICS.BEVERAGE_REQUEST, {
					bevandaId: selectedBeverage.id,
					importo: selectedBeverage.price,
					zucchero: sugarLevel,
					timestamp: Date.now()
				});
			} catch (error) {
				showAlert(`Non è possibile erogare: ${error.message}`);
			}
		}

        // Configurazione globale di axios per gestire gli errori di autenticazione
        axios.interceptors.response.use(
            response => response,
            async error => {
                if (error.response?.status === 401) {
                    // Token scaduto o non valido
                    localStorage.removeItem('jwt_token');
                    await AuthUtils.ensureAuthToken();
                    // Riprova la richiesta originale con il nuovo token
                    const originalRequest = error.config;
                    originalRequest.headers = AuthUtils.getAuthHeaders();
                    return axios(originalRequest);
                }
                return Promise.reject(error);
            }
        );

        // Event listeners per la gestione dei tab per categorie
        function filterBeverages(category) {
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('bg-blue-600', 'text-white');
                tab.classList.add('bg-gray-200');
            });
            
            document.querySelector(`.tab-button[data-category="${category}"]`).classList.remove('bg-gray-200');
            document.querySelector(`.tab-button[data-category="${category}"]`).classList.add('bg-blue-600', 'text-white');
            
            if (category === 'all') {
                document.querySelectorAll('.beverage-card').forEach(card => {
                    card.classList.remove('hidden');
                });
            } else {
                document.querySelectorAll('.beverage-card').forEach(card => {
                    const beverage = machineState.bevande.find(b => b.id === parseInt(card.dataset.id));
                    if (beverage && beverage.categoria === category) {
                        card.classList.remove('hidden');
                    } else {
                        card.classList.add('hidden');
                    }
                });
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Listener per i pulsanti moneta
            document.querySelectorAll('.coin-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const value = parseFloat(button.getAttribute('data-value'));
                    handleCoinInsertion(value);
                });
            });

            // Listener per i pulsanti zucchero
            document.querySelectorAll('.sugar-btn').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.sugar-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    sugarLevel = parseInt(button.getAttribute('data-level'));
                });
            });

            // Listener per i tab categorie
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.addEventListener('click', () => {
                    filterBeverages(tab.getAttribute('data-category'));
                });
            });

            // Listener per pulsanti azione
            elements.returnCreditButton.addEventListener('click', handleCreditReturn);
            elements.dispenseButton.addEventListener('click', handleBeverageRequest);
            elements.logoutBtn.addEventListener('click', AuthUtils.logout);
        }

        // Pulizia alla chiusura della pagina
        window.onbeforeunload = function() {
            resetCreditBeforeLeaving();
            
            // Disconnetti il client MQTT
            if (client && client.isConnected()) {
                client.disconnect();
            }
        };

        // Gestione navigazione
        window.addEventListener('popstate', resetCreditBeforeLeaving);
        
        // Intercetta la navigazione tramite link
        document.addEventListener('click', function(e) {
            // Verifica che sia un link
            if (e.target.tagName === 'A' || e.target.closest('a')) {
                resetCreditBeforeLeaving();
            }
        });

        // Setup iniziale
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeMachineState();
                setupEventListeners();
            } catch (error) {
                console.error('Errore durante l\'inizializzazione:', error);
                showAlert('Errore durante l\'inizializzazione dell\'interfaccia');
            }
        });
    </script>
</body>
</html>